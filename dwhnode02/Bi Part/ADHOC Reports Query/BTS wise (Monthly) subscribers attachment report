

--------------------------------------------------------------------------

DROP TABLE MONTH_BTS_WISE_TOTAL_ATTACHMENT_VOICE_PART;
CREATE TABLE  MONTH_BTS_WISE_TOTAL_ATTACHMENT_VOICE_PART
AS
(SELECT  /*+PARALLEL(P,15)*/ SITE_ID, DISTRICT,V372_CALLINGPARTYNUMBER,COUNT(*) VOICE_COUNT


FROM  L3_VOICE  P,ZONE_DIM R


WHERE (V387_CHARGINGTIME_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE('01/01/2021','DD/MM/RRRR'))
                                                       AND  (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE('31/01/2021','DD/MM/RRRR')))                      

AND  V378_SERVICEFLOW='1'
AND  V381_CALLINGCELLID=CGI
GROUP BY  SITE_ID, DISTRICT,V372_CALLINGPARTYNUMBER
);


------------------------------------------------------------------------------

DROP TABLE MONTH_BTS_WISE_TOTAL_ATTACHMENT_DATA_PART;
CREATE TABLE  MONTH_BTS_WISE_TOTAL_ATTACHMENT_DATA_PART
AS
SELECT /*+PARALLAL(P,16)*/SITE_ID, DISTRICT,G372_CALLINGPARTYNUMBER,COUNT(*) DATA_COUNT
 FROM 
(

SELECT /*+PARALLAL(G,16)*/  G.G372_CALLINGPARTYNUMBER,


CASE


WHEN LENGTH(G379_CALLINGCELLID)=15


THEN G379_CALLINGCELLID


WHEN LENGTH(G379_CALLINGCELLID)=30


THEN SUBSTR(G379_CALLINGCELLID,16,15)


END G379_CALLINGCELLID


FROM L3_DATA G


WHERE  (G383_CHARGINGTIME_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE('01/01/2021','DD/MM/RRRR'))
                                                       AND  (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE('31/01/2021','DD/MM/RRRR'))) 

)P,ZONE_DIM Q
WHERE G379_CALLINGCELLID=CGI
GROUP BY SITE_ID, DISTRICT,G372_CALLINGPARTYNUMBER


-------------------------------------------------------------------------------


DROP TABLE MONTH_BTS_WISE_TOTAL_ATTACHMENT_MSC_PART_1;
CREATE TABLE  MONTH_BTS_WISE_TOTAL_ATTACHMENT_MSC_PART_1
AS
(

SELECT /*+PARALLAL(M,16)*/   SITE_ID, DISTRICT,M04_MSISDNAPARTY,COUNT(*) MSC_COUNT


FROM L1_MSC@DWH05TODWH03 M,ZONE_DIM Q


WHERE PROCESSED_DATE BETWEEN TO_DATE('01/JANUARY/2021','DD/MM/RRRR') AND TO_DATE('03/FEBRUARY/2021','DD/MM/RRRR')


AND M07_ANSWERTIMESTAMP_KEY IN (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE BETWEEN TO_DATE('01/01/2021','DD/MM/RRRR') AND TO_DATE('31/01/2021','DD/MM/RRRR'))


AND M01_CALLTYPE ='MTC'
AND (M08_CALLDUR !=0)
AND M09_LOCATION=CGI
GROUP BY SITE_ID, DISTRICT,M04_MSISDNAPARTY

)


-----------------------------------------------------------------------------------


DROP TABLE MONTH_BTS_WISE_TOTAL_ATTACHMENT_MSC_PART_2;
CREATE TABLE  MONTH_BTS_WISE_TOTAL_ATTACHMENT_MSC_PART_2
AS
(

SELECT /*+PARALLAL(M,16)*/   SITE_ID, DISTRICT,M04_MSISDNAPARTY,COUNT(*) MSC_COUNT_2


FROM L1_MSC@DWH05TODWH03 M,ZONE_DIM Q


WHERE PROCESSED_DATE BETWEEN TO_DATE('01/JANUARY/2021','DD/MM/RRRR') AND TO_DATE('03/FEBRUARY/2021','DD/MM/RRRR')


AND  (M07_ANSWERTIMESTAMP_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE('01/01/2021','DD/MM/RRRR'))
                                                       AND  (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE('31/01/2021','DD/MM/RRRR'))) 

AND M01_CALLTYPE IN ('SMSMO','SMSMT','CFW')
AND M09_LOCATION=CGI
GROUP BY SITE_ID, DISTRICT,M04_MSISDNAPARTY

)


-------------------------------------------------------------------------FINAL QUERY--------------------------------------------------------




SELECT /*+PARALLEL(A,15)*/SITE_ID, DISTRICT,COUNT(UNIQUE MSISDN)TOTAL_ATTACH
FROM 
(SELECT /*+PARALLEL(A,15)*/ SITE_ID, DISTRICT, MSISDN, ACTIVITY_COUNT FROM
(SELECT /*+PARALLEL(A,15)*/ SITE_ID, DISTRICT, MSISDN,COUNTONE ACTIVITY_COUNT,
                           ROW_NUMBER() OVER (PARTITION BY MSISDN ORDER BY COUNTONE DESC ) AS ROW_NUM
FROM
(SELECT /*+PARALLEL(P,15)*/SITE_ID, DISTRICT, MSISDN, COUNTONE,
            RANK() OVER(
            PARTITION BY MSISDN
            ORDER BY COUNTONE DESC)
            COUNT_RANK

FROM
(SELECT /*+PARALLAL(P,16)*/SITE_ID,DISTRICT,V372_CALLINGPARTYNUMBER MSISDN,SUM(VOICE_COUNT) COUNTONE FROM 
(SELECT * FROM MONTH_BTS_WISE_TOTAL_ATTACHMENT_VOICE_PART
UNION ALL
SELECT * FROM MONTH_BTS_WISE_TOTAL_ATTACHMENT_DATA_PART
UNION ALL
SELECT * FROM MONTH_BTS_WISE_TOTAL_ATTACHMENT_MSC_PART_1
UNION ALL
SELECT * FROM MONTH_BTS_WISE_TOTAL_ATTACHMENT_MSC_PART_2
)P
GROUP BY SITE_ID,DISTRICT,V372_CALLINGPARTYNUMBER
) P
)A
WHERE COUNT_RANK=1
)A
WHERE ROW_NUM=1
)A
GROUP BY SITE_ID, DISTRICT
