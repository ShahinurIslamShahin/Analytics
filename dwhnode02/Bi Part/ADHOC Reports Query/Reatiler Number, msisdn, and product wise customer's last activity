SELECT /*+PARALLEL(P,15)*/ * FROM  
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS, LAST_MT_VOICE_ACTIVITY_DATE,
       LAST_MO_SMS_ACTIVITY_DATE,LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,DATE_VALUE LAST_RECHARGE_DATE,LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY,LAST_MO_SMS_ACTIVITY_DATE,LU_GPRS_DATE_KEY, DATE_VALUE LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, DATE_VALUE LAST_MO_SMS_ACTIVITY_DATE,
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE,MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY,DATE_VALUE LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, 
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT

 FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, DATE_VALUE LAST_MO_VOICE_ACTIVITY_DATE ,LAST_MO_VOICE_USAGE_MINS ,
        LU_MTC_DATE_KEY, 
        LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
        
        FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, LU_MOC_ACTUAL_DURATION/60 LAST_MO_VOICE_USAGE_MINS, LU_MTC_DATE_KEY, 
        LU_MTC_ACTUAL_DURATION/60 LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY, LU_GPRS_DATA_SIZE LAST_DATA_USAGE_MB, LR_DATE_KEY, RE9_ORIGINAL_AMT LAST_RECHARGE_AMOUNT
FROM 



(
SELECT * FROM 
 (SELECT /*+PARALLEL(P,15)*/  SAF_MSISDN,SAF_RETAILERMOBILE,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4
AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN','NEW_POSTPAID','RE-REGISTRATION','POSTPAID','PREPAID')

) E
RIGHT OUTER JOIN
(SELECT MSISDN,LU_PRODUCT_KEY,LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
      LU_MOSMS_DATE_KEY,LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,LR_DATE_KEY,LR_PRODUCT_KEY,RE9_ORIGINAL_AMT

 FROM 
(
SELECT /*+PARALLEL(P,15)*/ MSISDN,LU_PRODUCT_KEY,
        LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,
        LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
        LU_MOSMS_DATE_KEY,
        LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,
        LR_DATE_KEY,
        LR_PRODUCT_KEY
        
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY <(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-7,'DD/MM/RRRR'))
AND LU_DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
)A

LEFT OUTER JOIN


(SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,RE30_ENTRY_DATE_KEY,RE9_ORIGINAL_AMT


 FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
                          AND EXISTS (SELECT * FROM
                          (SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,MAX(TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))) DATE_HOUR

FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
GROUP BY RE6_PRI_IDENTITY)R WHERE P.RE6_PRI_IDENTITY=R.RE6_PRI_IDENTITY AND TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))=R.DATE_HOUR
)
)B ON MSISDN=RE6_PRI_IDENTITY

) F
ON SAF_MSISDN=MSISDN
)

 P



LEFT OUTER JOIN
PRODUCT_DIM Q ON (LU_PRODUCT_KEY=Q.PRODUCT_ID OR (LR_PRODUCT_KEY=Q.PRODUCT_ID AND P.LU_PRODUCT_KEY=0))
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MTC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOSMS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_GPRS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LR_DATE_KEY=DATE_KEY
)
P
WHERE PRODUCT_NAME IN ('Bornomala 3G','Shotoborsho')
AND SAF_RETAILERMOBILE IS NOT NULLSELECT /*+PARALLEL(P,15)*/ * FROM  
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS, LAST_MT_VOICE_ACTIVITY_DATE,
       LAST_MO_SMS_ACTIVITY_DATE,LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,DATE_VALUE LAST_RECHARGE_DATE,LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY,LAST_MO_SMS_ACTIVITY_DATE,LU_GPRS_DATE_KEY, DATE_VALUE LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, DATE_VALUE LAST_MO_SMS_ACTIVITY_DATE,
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE,MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY,DATE_VALUE LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, 
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT

 FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, DATE_VALUE LAST_MO_VOICE_ACTIVITY_DATE ,LAST_MO_VOICE_USAGE_MINS ,
        LU_MTC_DATE_KEY, 
        LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
        
        FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, LU_MOC_ACTUAL_DURATION/60 LAST_MO_VOICE_USAGE_MINS, LU_MTC_DATE_KEY, 
        LU_MTC_ACTUAL_DURATION/60 LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY, LU_GPRS_DATA_SIZE LAST_DATA_USAGE_MB, LR_DATE_KEY, RE9_ORIGINAL_AMT LAST_RECHARGE_AMOUNT
FROM 



(
SELECT * FROM 
 (SELECT /*+PARALLEL(P,15)*/  SAF_MSISDN,SAF_RETAILERMOBILE,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4
AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN','NEW_POSTPAID','RE-REGISTRATION','POSTPAID','PREPAID')

) E
RIGHT OUTER JOIN
(SELECT MSISDN,LU_PRODUCT_KEY,LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
      LU_MOSMS_DATE_KEY,LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,LR_DATE_KEY,LR_PRODUCT_KEY,RE9_ORIGINAL_AMT

 FROM 
(
SELECT /*+PARALLEL(P,15)*/ MSISDN,LU_PRODUCT_KEY,
        LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,
        LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
        LU_MOSMS_DATE_KEY,
        LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,
        LR_DATE_KEY,
        LR_PRODUCT_KEY
        
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY <(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-7,'DD/MM/RRRR'))
AND LU_DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
)A

LEFT OUTER JOIN


(SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,RE30_ENTRY_DATE_KEY,RE9_ORIGINAL_AMT


 FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
                          AND EXISTS (SELECT * FROM
                          (SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,MAX(TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))) DATE_HOUR

FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
GROUP BY RE6_PRI_IDENTITY)R WHERE P.RE6_PRI_IDENTITY=R.RE6_PRI_IDENTITY AND TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))=R.DATE_HOUR
)
)B ON MSISDN=RE6_PRI_IDENTITY

) F
ON SAF_MSISDN=MSISDN
)

 P



LEFT OUTER JOIN
PRODUCT_DIM Q ON (LU_PRODUCT_KEY=Q.PRODUCT_ID OR (LR_PRODUCT_KEY=Q.PRODUCT_ID AND P.LU_PRODUCT_KEY=0))
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MTC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOSMS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_GPRS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LR_DATE_KEY=DATE_KEY
)
P
WHERE PRODUCT_NAME IN ('Bornomala 3G','Shotoborsho')
AND SAF_RETAILERMOBILE IS NOT NULLSELECT /*+PARALLEL(P,15)*/ * FROM  
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS, LAST_MT_VOICE_ACTIVITY_DATE,
       LAST_MO_SMS_ACTIVITY_DATE,LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,DATE_VALUE LAST_RECHARGE_DATE,LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY,LAST_MO_SMS_ACTIVITY_DATE,LU_GPRS_DATE_KEY, DATE_VALUE LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, DATE_VALUE LAST_MO_SMS_ACTIVITY_DATE,
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE,MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY,DATE_VALUE LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, 
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT

 FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, DATE_VALUE LAST_MO_VOICE_ACTIVITY_DATE ,LAST_MO_VOICE_USAGE_MINS ,
        LU_MTC_DATE_KEY, 
        LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
        
        FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, LU_MOC_ACTUAL_DURATION/60 LAST_MO_VOICE_USAGE_MINS, LU_MTC_DATE_KEY, 
        LU_MTC_ACTUAL_DURATION/60 LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY, LU_GPRS_DATA_SIZE LAST_DATA_USAGE_MB, LR_DATE_KEY, RE9_ORIGINAL_AMT LAST_RECHARGE_AMOUNT
FROM 



(
SELECT * FROM 
 (SELECT /*+PARALLEL(P,15)*/  SAF_MSISDN,SAF_RETAILERMOBILE,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4
AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN','NEW_POSTPAID','RE-REGISTRATION','POSTPAID','PREPAID')

) E
RIGHT OUTER JOIN
(SELECT MSISDN,LU_PRODUCT_KEY,LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
      LU_MOSMS_DATE_KEY,LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,LR_DATE_KEY,LR_PRODUCT_KEY,RE9_ORIGINAL_AMT

 FROM 
(
SELECT /*+PARALLEL(P,15)*/ MSISDN,LU_PRODUCT_KEY,
        LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,
        LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
        LU_MOSMS_DATE_KEY,
        LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,
        LR_DATE_KEY,
        LR_PRODUCT_KEY
        
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY <(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-7,'DD/MM/RRRR'))
AND LU_DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
)A

LEFT OUTER JOIN


(SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,RE30_ENTRY_DATE_KEY,RE9_ORIGINAL_AMT


 FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
                          AND EXISTS (SELECT * FROM
                          (SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,MAX(TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))) DATE_HOUR

FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
GROUP BY RE6_PRI_IDENTITY)R WHERE P.RE6_PRI_IDENTITY=R.RE6_PRI_IDENTITY AND TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))=R.DATE_HOUR
)
)B ON MSISDN=RE6_PRI_IDENTITY

) F
ON SAF_MSISDN=MSISDN
)

 P



LEFT OUTER JOIN
PRODUCT_DIM Q ON (LU_PRODUCT_KEY=Q.PRODUCT_ID OR (LR_PRODUCT_KEY=Q.PRODUCT_ID AND P.LU_PRODUCT_KEY=0))
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MTC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOSMS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_GPRS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LR_DATE_KEY=DATE_KEY
)
P
WHERE PRODUCT_NAME IN ('Bornomala 3G','Shotoborsho')
AND SAF_RETAILERMOBILE IS NOT NULLSELECT /*+PARALLEL(P,15)*/ * FROM  
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS, LAST_MT_VOICE_ACTIVITY_DATE,
       LAST_MO_SMS_ACTIVITY_DATE,LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,DATE_VALUE LAST_RECHARGE_DATE,LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY,LAST_MO_SMS_ACTIVITY_DATE,LU_GPRS_DATE_KEY, DATE_VALUE LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, DATE_VALUE LAST_MO_SMS_ACTIVITY_DATE,
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE,MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY,DATE_VALUE LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, 
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT

 FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, DATE_VALUE LAST_MO_VOICE_ACTIVITY_DATE ,LAST_MO_VOICE_USAGE_MINS ,
        LU_MTC_DATE_KEY, 
        LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
        
        FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, LU_MOC_ACTUAL_DURATION/60 LAST_MO_VOICE_USAGE_MINS, LU_MTC_DATE_KEY, 
        LU_MTC_ACTUAL_DURATION/60 LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY, LU_GPRS_DATA_SIZE LAST_DATA_USAGE_MB, LR_DATE_KEY, RE9_ORIGINAL_AMT LAST_RECHARGE_AMOUNT
FROM 



(
SELECT * FROM 
 (SELECT /*+PARALLEL(P,15)*/  SAF_MSISDN,SAF_RETAILERMOBILE,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4
AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN','NEW_POSTPAID','RE-REGISTRATION','POSTPAID','PREPAID')

) E
RIGHT OUTER JOIN
(SELECT MSISDN,LU_PRODUCT_KEY,LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
      LU_MOSMS_DATE_KEY,LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,LR_DATE_KEY,LR_PRODUCT_KEY,RE9_ORIGINAL_AMT

 FROM 
(
SELECT /*+PARALLEL(P,15)*/ MSISDN,LU_PRODUCT_KEY,
        LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,
        LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
        LU_MOSMS_DATE_KEY,
        LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,
        LR_DATE_KEY,
        LR_PRODUCT_KEY
        
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY <(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-7,'DD/MM/RRRR'))
AND LU_DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
)A

LEFT OUTER JOIN


(SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,RE30_ENTRY_DATE_KEY,RE9_ORIGINAL_AMT


 FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
                          AND EXISTS (SELECT * FROM
                          (SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,MAX(TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))) DATE_HOUR

FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
GROUP BY RE6_PRI_IDENTITY)R WHERE P.RE6_PRI_IDENTITY=R.RE6_PRI_IDENTITY AND TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))=R.DATE_HOUR
)
)B ON MSISDN=RE6_PRI_IDENTITY

) F
ON SAF_MSISDN=MSISDN
)

 P



LEFT OUTER JOIN
PRODUCT_DIM Q ON (LU_PRODUCT_KEY=Q.PRODUCT_ID OR (LR_PRODUCT_KEY=Q.PRODUCT_ID AND P.LU_PRODUCT_KEY=0))
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MTC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOSMS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_GPRS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LR_DATE_KEY=DATE_KEY
)
P
WHERE PRODUCT_NAME IN ('Bornomala 3G','Shotoborsho')
AND SAF_RETAILERMOBILE IS NOT NULLSELECT /*+PARALLEL(P,15)*/ * FROM  
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS, LAST_MT_VOICE_ACTIVITY_DATE,
       LAST_MO_SMS_ACTIVITY_DATE,LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,DATE_VALUE LAST_RECHARGE_DATE,LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY,LAST_MO_SMS_ACTIVITY_DATE,LU_GPRS_DATE_KEY, DATE_VALUE LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, DATE_VALUE LAST_MO_SMS_ACTIVITY_DATE,
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE,MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY,DATE_VALUE LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, 
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT

 FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, DATE_VALUE LAST_MO_VOICE_ACTIVITY_DATE ,LAST_MO_VOICE_USAGE_MINS ,
        LU_MTC_DATE_KEY, 
        LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
        
        FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, LU_MOC_ACTUAL_DURATION/60 LAST_MO_VOICE_USAGE_MINS, LU_MTC_DATE_KEY, 
        LU_MTC_ACTUAL_DURATION/60 LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY, LU_GPRS_DATA_SIZE LAST_DATA_USAGE_MB, LR_DATE_KEY, RE9_ORIGINAL_AMT LAST_RECHARGE_AMOUNT
FROM 



(
SELECT * FROM 
 (SELECT /*+PARALLEL(P,15)*/  SAF_MSISDN,SAF_RETAILERMOBILE,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4
AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN','NEW_POSTPAID','RE-REGISTRATION','POSTPAID','PREPAID')

) E
RIGHT OUTER JOIN
(SELECT MSISDN,LU_PRODUCT_KEY,LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
      LU_MOSMS_DATE_KEY,LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,LR_DATE_KEY,LR_PRODUCT_KEY,RE9_ORIGINAL_AMT

 FROM 
(
SELECT /*+PARALLEL(P,15)*/ MSISDN,LU_PRODUCT_KEY,
        LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,
        LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
        LU_MOSMS_DATE_KEY,
        LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,
        LR_DATE_KEY,
        LR_PRODUCT_KEY
        
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY <(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-7,'DD/MM/RRRR'))
AND LU_DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
)A

LEFT OUTER JOIN


(SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,RE30_ENTRY_DATE_KEY,RE9_ORIGINAL_AMT


 FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
                          AND EXISTS (SELECT * FROM
                          (SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,MAX(TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))) DATE_HOUR

FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
GROUP BY RE6_PRI_IDENTITY)R WHERE P.RE6_PRI_IDENTITY=R.RE6_PRI_IDENTITY AND TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))=R.DATE_HOUR
)
)B ON MSISDN=RE6_PRI_IDENTITY

) F
ON SAF_MSISDN=MSISDN
)

 P



LEFT OUTER JOIN
PRODUCT_DIM Q ON (LU_PRODUCT_KEY=Q.PRODUCT_ID OR (LR_PRODUCT_KEY=Q.PRODUCT_ID AND P.LU_PRODUCT_KEY=0))
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MTC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOSMS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_GPRS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LR_DATE_KEY=DATE_KEY
)
P
WHERE PRODUCT_NAME IN ('Bornomala 3G','Shotoborsho')
AND SAF_RETAILERMOBILE IS NOT NULLSELECT /*+PARALLEL(P,15)*/ * FROM  
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS, LAST_MT_VOICE_ACTIVITY_DATE,
       LAST_MO_SMS_ACTIVITY_DATE,LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,DATE_VALUE LAST_RECHARGE_DATE,LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY,LAST_MO_SMS_ACTIVITY_DATE,LU_GPRS_DATE_KEY, DATE_VALUE LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, DATE_VALUE LAST_MO_SMS_ACTIVITY_DATE,
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE,MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY,DATE_VALUE LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, 
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT

 FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, DATE_VALUE LAST_MO_VOICE_ACTIVITY_DATE ,LAST_MO_VOICE_USAGE_MINS ,
        LU_MTC_DATE_KEY, 
        LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
        
        FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, LU_MOC_ACTUAL_DURATION/60 LAST_MO_VOICE_USAGE_MINS, LU_MTC_DATE_KEY, 
        LU_MTC_ACTUAL_DURATION/60 LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY, LU_GPRS_DATA_SIZE LAST_DATA_USAGE_MB, LR_DATE_KEY, RE9_ORIGINAL_AMT LAST_RECHARGE_AMOUNT
FROM 



(
SELECT * FROM 
 (SELECT /*+PARALLEL(P,15)*/  SAF_MSISDN,SAF_RETAILERMOBILE,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4
AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN','NEW_POSTPAID','RE-REGISTRATION','POSTPAID','PREPAID')

) E
RIGHT OUTER JOIN
(SELECT MSISDN,LU_PRODUCT_KEY,LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
      LU_MOSMS_DATE_KEY,LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,LR_DATE_KEY,LR_PRODUCT_KEY,RE9_ORIGINAL_AMT

 FROM 
(
SELECT /*+PARALLEL(P,15)*/ MSISDN,LU_PRODUCT_KEY,
        LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,
        LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
        LU_MOSMS_DATE_KEY,
        LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,
        LR_DATE_KEY,
        LR_PRODUCT_KEY
        
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY <(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-7,'DD/MM/RRRR'))
AND LU_DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
)A

LEFT OUTER JOIN


(SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,RE30_ENTRY_DATE_KEY,RE9_ORIGINAL_AMT


 FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
                          AND EXISTS (SELECT * FROM
                          (SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,MAX(TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))) DATE_HOUR

FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
GROUP BY RE6_PRI_IDENTITY)R WHERE P.RE6_PRI_IDENTITY=R.RE6_PRI_IDENTITY AND TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))=R.DATE_HOUR
)
)B ON MSISDN=RE6_PRI_IDENTITY

) F
ON SAF_MSISDN=MSISDN
)

 P



LEFT OUTER JOIN
PRODUCT_DIM Q ON (LU_PRODUCT_KEY=Q.PRODUCT_ID OR (LR_PRODUCT_KEY=Q.PRODUCT_ID AND P.LU_PRODUCT_KEY=0))
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MTC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOSMS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_GPRS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LR_DATE_KEY=DATE_KEY
)
P
WHERE PRODUCT_NAME IN ('Bornomala 3G','Shotoborsho')
AND SAF_RETAILERMOBILE IS NOT NULLSELECT /*+PARALLEL(P,15)*/ * FROM  
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS, LAST_MT_VOICE_ACTIVITY_DATE,
       LAST_MO_SMS_ACTIVITY_DATE,LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,DATE_VALUE LAST_RECHARGE_DATE,LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY,LAST_MO_SMS_ACTIVITY_DATE,LU_GPRS_DATE_KEY, DATE_VALUE LAST_DATA_USAGE_ACTIVITY_DATE,
       LAST_DATA_USAGE_MB,LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY, LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, DATE_VALUE LAST_MO_SMS_ACTIVITY_DATE,
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
       FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE,MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,LU_MOC_DATE_KEY,
       LAST_MO_VOICE_ACTIVITY_DATE,LAST_MO_VOICE_USAGE_MINS,LU_MTC_DATE_KEY,DATE_VALUE LAST_MT_VOICE_ACTIVITY_DATE,
       LU_MOSMS_DATE_KEY, 
       LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT

 FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, DATE_VALUE LAST_MO_VOICE_ACTIVITY_DATE ,LAST_MO_VOICE_USAGE_MINS ,
        LU_MTC_DATE_KEY, 
        LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY,  LAST_DATA_USAGE_MB, LR_DATE_KEY,  LAST_RECHARGE_AMOUNT
        
        FROM
(SELECT /*+PARALLEL(P,15)*/ SAF_RETAILERMOBILE, MSISDN,PRODUCT_NAME,SAF_ENTRYDATE,
        LU_MOC_DATE_KEY, LU_MOC_ACTUAL_DURATION/60 LAST_MO_VOICE_USAGE_MINS, LU_MTC_DATE_KEY, 
        LU_MTC_ACTUAL_DURATION/60 LAST_MT_VOICE_USAGE_MINS, LU_MOSMS_DATE_KEY, 
        LU_GPRS_DATE_KEY, LU_GPRS_DATA_SIZE LAST_DATA_USAGE_MB, LR_DATE_KEY, RE9_ORIGINAL_AMT LAST_RECHARGE_AMOUNT
FROM 



(
SELECT * FROM 
 (SELECT /*+PARALLEL(P,15)*/  SAF_MSISDN,SAF_RETAILERMOBILE,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4
AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN','NEW_POSTPAID','RE-REGISTRATION','POSTPAID','PREPAID')

) E
RIGHT OUTER JOIN
(SELECT MSISDN,LU_PRODUCT_KEY,LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
      LU_MOSMS_DATE_KEY,LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,LR_DATE_KEY,LR_PRODUCT_KEY,RE9_ORIGINAL_AMT

 FROM 
(
SELECT /*+PARALLEL(P,15)*/ MSISDN,LU_PRODUCT_KEY,
        LU_MOC_DATE_KEY,LU_MOC_ACTUAL_DURATION,
        LU_MTC_DATE_KEY,LU_MTC_ACTUAL_DURATION,
        LU_MOSMS_DATE_KEY,
        LU_GPRS_DATE_KEY,LU_GPRS_DATA_SIZE,
        LR_DATE_KEY,
        LR_PRODUCT_KEY
        
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY <(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-7,'DD/MM/RRRR'))
AND LU_DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
)A

LEFT OUTER JOIN


(SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,RE30_ENTRY_DATE_KEY,RE9_ORIGINAL_AMT


 FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
                          AND EXISTS (SELECT * FROM
                          (SELECT /*+PARALLEL(P,15)*/  RE6_PRI_IDENTITY,MAX(TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))) DATE_HOUR

FROM L3_RECHARGE P
WHERE (RE30_ENTRY_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                          AND (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-8,'DD/MM/RRRR')))
GROUP BY RE6_PRI_IDENTITY)R WHERE P.RE6_PRI_IDENTITY=R.RE6_PRI_IDENTITY AND TO_NUMBER(CONCAT (RE30_ENTRY_DATE_KEY,RE30_ENTRY_HOUR))=R.DATE_HOUR
)
)B ON MSISDN=RE6_PRI_IDENTITY

) F
ON SAF_MSISDN=MSISDN
)

 P



LEFT OUTER JOIN
PRODUCT_DIM Q ON (LU_PRODUCT_KEY=Q.PRODUCT_ID OR (LR_PRODUCT_KEY=Q.PRODUCT_ID AND P.LU_PRODUCT_KEY=0))
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MTC_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_MOSMS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LU_GPRS_DATE_KEY=DATE_KEY
)P
LEFT OUTER JOIN
DATE_DIM Q ON LR_DATE_KEY=DATE_KEY
)
P
WHERE PRODUCT_NAME IN ('Bornomala 3G','Shotoborsho')
AND SAF_RETAILERMOBILE IS NOT NULL