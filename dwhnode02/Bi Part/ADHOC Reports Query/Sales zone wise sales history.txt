SELECT P.CUSTOMER_NO,
P.CUSTOMER_NAME,
P.ISS_DATE,
P.LFTPOINT_NAME,
To_CHAR(TOTAL_RETAILER_LIFT)TOTAL_RETAILER_LIFT,
P.RETAILER_NO,
P.RETAILER_NAME,
P.TELECHARGE_NO,
P.TODAY_LIFT,
P.TOTAL_LIFT,
P.TODAY_ACTIVE,
NVL(NEW_ACTIVATION,0)NEW_ACTIVATION,
NVL(OLD_ACTIVATION,0)OLD_ACTIVATION,
P.TOTAL_ACTIVE,
P.B2W,
P.CURRENT_STOCK,
P.SALES_BLOCK

 FROM 
(SELECT T1.CUSTOMER_NO,
D.CUSTOMER_NAME,
T1.ISS_DATE,
D.LFTPOINT_NAME,
T1.RETAILER_NO,

R.RETAILER_NAME,
R.TELECHARGE_NO,
T1.TODAY_LIFT,
T1.TOTAL_LIFT,
T1.TODAY_ACTIVE,
T1.TOTAL_ACTIVE,
T1.B2W,
(T1.TOTAL_LIFT - NVL (T1.TOTAL_ACTIVE, 0))
CURRENT_STOCK,
TOTAL_CLAIM,
NVL ((SELECT 'YES'
FROM SYNM_DMS_CLAIM_RETAILER@DWH05TODMS
WHERE RETAILER_NO = T1.RETAILER_NO AND INACTIVE_STAT = 1),
'NO')
SALES_BLOCK
FROM 
( SELECT I.ISS_2_RETAILER_NO
RETAILER_NO,
I.CUSTOMER_NO,
I.ISS_DATE, 
SUM (I.ISS_QTY)
TOTAL_LIFT,
SUM (
CASE
WHEN TRUNC (I.ISS_2_RETAILER_DTTM) = TRUNC(SYSDATE-1)
THEN
I.ISS_QTY
ELSE
0
END)
TODAY_LIFT,
COUNT (A.ITEM_MOB_NO)
TOTAL_ACTIVE,
SUM (
CASE
WHEN TRUNC (A.ACTIVATE_DTTM) = TRUNC(SYSDATE-1) THEN 1
ELSE 0
END)
TODAY_ACTIVE,
SUM (
CASE
WHEN TRUNC (A.ACTIVATE_DTTM) = TRUNC(SYSDATE-1) 
AND (A.ITEM_MOB_NO) IN (SELECT MSISDN_NO FROM SYNM_DMS_CLAIM_MSISDN@DWH05TODMS)
THEN 1
ELSE 0
END)
B2W,

SUM (NVL (CLAIM_FLAG, 0))
TOTAL_CLAIM
FROM SYNM_DMS_ITEMISSUEDTL@DWH05TODMS I
LEFT OUTER JOIN SYNM_DMS_ACTIVATION@DWH05TODMS A
ON ( I.ISS_2_RETAILER_NO = A.RETAILER_NO
AND I.ERP_ITEM_NO = A.ERP_ITEM_NO)
WHERE I.ERP_ITEM_NO = 15186 AND I.ISS_2_RETAILER_NO IS NOT NULL
GROUP BY I.ISS_DATE,I.ISS_2_RETAILER_NO, I.CUSTOMER_NO) T1
JOIN SYNM_DMS_RETAILER_INFO@DWH05TODMS R ON (T1.RETAILER_NO = R.RETAILER_NO)
JOIN SYNM_DMS_DEALER_INFO@DWH05TODMS D ON (T1.CUSTOMER_NO = D.CUSTOMER_NO)
)P
LEFT OUTER JOIN

( SELECT/*+PARALLEL(I,15)*/ I.ISS_2_RETAILER_NO
RETAILER_NO,
I.CUSTOMER_NO,
I.ISS_DATE,
COUNT(A.ITEM_MOB_NO) 
NEW_ACTIVATION,


SUM (NVL (CLAIM_FLAG, 0))
TOTAL_CLAIM
FROM SYNM_DMS_ITEMISSUEDTL@DWH05TODMS I
LEFT OUTER JOIN SYNM_DMS_ACTIVATION@DWH05TODMS A
ON ( I.ISS_2_RETAILER_NO = A.RETAILER_NO
AND I.ERP_ITEM_NO = A.ERP_ITEM_NO)
WHERE I.ERP_ITEM_NO = 15186 AND I.ISS_2_RETAILER_NO IS NOT NULL
AND TRUNC (A.ACTIVATE_DTTM) = TRUNC(SYSDATE-1) 
AND NOT EXISTS  (SELECT * FROM 
(SELECT MSISDN FROM L3_ETSAF
WHERE TYPE IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND ENTRY_DATE = TO_DATE (SYSDATE-1)
AND NID IN (SELECT NID FROM L3_ETSAF
WHERE TYPE IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND ENTRY_DATE < TO_DATE (SYSDATE-1))
GROUP BY  MSISDN
) P
WHERE CONCAT('880',A.ITEM_MOB_NO)=P.MSISDN
)
GROUP BY I.ISS_DATE,I.ISS_2_RETAILER_NO, I.CUSTOMER_NO)Q ON P.RETAILER_NO=Q.RETAILER_NO AND P.CUSTOMER_NO=Q.CUSTOMER_NO AND P.ISS_DATE=Q.ISS_DATE
LEFT OUTER JOIN

( SELECT/*+PARALLEL(I,15)*/ I.ISS_2_RETAILER_NO
RETAILER_NO,
I.CUSTOMER_NO,
I.ISS_DATE,
COUNT(A.ITEM_MOB_NO) 
OLD_ACTIVATION,


SUM (NVL (CLAIM_FLAG, 0))
TOTAL_CLAIM
FROM SYNM_DMS_ITEMISSUEDTL@DWH05TODMS I
LEFT OUTER JOIN SYNM_DMS_ACTIVATION@DWH05TODMS A
ON ( I.ISS_2_RETAILER_NO = A.RETAILER_NO
AND I.ERP_ITEM_NO = A.ERP_ITEM_NO)
WHERE I.ERP_ITEM_NO = 15186 AND I.ISS_2_RETAILER_NO IS NOT NULL
AND TRUNC (A.ACTIVATE_DTTM) = TRUNC(SYSDATE-1) 
AND EXISTS  (SELECT * FROM 
(SELECT MSISDN FROM L3_ETSAF
WHERE TYPE IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND ENTRY_DATE = TO_DATE (SYSDATE-1)
AND NID IN (SELECT NID FROM L3_ETSAF
WHERE TYPE IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND ENTRY_DATE < TO_DATE (SYSDATE-1))
GROUP BY  MSISDN
) P
WHERE CONCAT('880',A.ITEM_MOB_NO)=P.MSISDN
)
GROUP BY I.ISS_DATE,I.ISS_2_RETAILER_NO, I.CUSTOMER_NO)R ON P.RETAILER_NO=R.RETAILER_NO AND P.CUSTOMER_NO=R.CUSTOMER_NO AND P.ISS_DATE=R.ISS_DATE
LEFT OUTER JOIN

( SELECT/*+PARALLEL(I,15)*/ 
I.CUSTOMER_NO,
I.ISS_DATE,
SUM (I.ISS_QTY)
TOTAL_RETAILER_LIFT
FROM SYNM_DMS_ITEMISSUEDTL@DWH05TODMS I
LEFT OUTER JOIN SYNM_DMS_ACTIVATION@DWH05TODMS A
ON ( I.ISS_2_RETAILER_NO = A.RETAILER_NO
AND I.ERP_ITEM_NO = A.ERP_ITEM_NO)
WHERE I.ERP_ITEM_NO = 15186 AND I.ISS_2_RETAILER_NO IS NOT NULL

GROUP BY I.ISS_DATE, I.CUSTOMER_NO)S  ON P.CUSTOMER_NO=S.CUSTOMER_NO AND P.ISS_DATE=S.ISS_DATE