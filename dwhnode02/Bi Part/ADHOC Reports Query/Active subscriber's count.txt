SELECT P.PRODUCT_NAME,COALESCE (ACTIVE_SUBSCRIBERS_COUNT, 0)ACTIVE_SUBSCRIBERS_COUNT,COALESCE (DATA_ACTIVE_SUBSCRIBERS_COUNT, 0)DATA_ACTIVE_SUBSCRIBERS_COUNT
FROM 
PRODUCT_DIM P

LEFT OUTER JOIN

(select PRODUCT_NAME, count(MSISDN)  ACTIVE_SUBSCRIBERS_COUNT from
(select /*+PARALLEL(P,15)*/PRODUCT_NAME, MSISDN
from
(SELECT /*+PARALLEL(A,15)*/ A.MSISDN, C.PRODUCT_NAME
FROM LAST_ACTIVITY_FCT_LD A, PRODUCT_DIM C
WHERE (LU_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(sysdate-90,'DD/MM/RRRR'))
                                                       AND  (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(sysdate-1,'DD/MM/RRRR'))) and 
 ((A.LU_MOC_PRODUCT_KEY=C.PRODUCT_ID) or (A.LU_MTC_PRODUCT_KEY=C.PRODUCT_ID) or (A.LU_MOSMS_PRODUCT_KEY=C.PRODUCT_ID) 
or (A.LU_GPRS_PRODUCT_KEY=C.PRODUCT_ID) or (A.LR_PRODUCT_KEY=C.PRODUCT_ID))
)P
--where PRODUCT_NAME ='Maayer Hasi '
group by MSISDN,PRODUCT_NAME
)
group by PRODUCT_NAME
) Q ON P.PRODUCT_NAME=Q.PRODUCT_NAME

LEFT OUTER JOIN 

(SELECT A.PRODUCT_NAME,COUNT(UNIQUE G372_CALLINGPARTYNUMBER) DATA_ACTIVE_SUBSCRIBERS_COUNT  FROM PRODUCT_DIM A,
(SELECT G401_MAINOFFERINGID,G372_CALLINGPARTYNUMBER
FROM
(SELECT /*+PARALLEL(P,15)*/ G401_MAINOFFERINGID,G372_CALLINGPARTYNUMBER,SUM (G384_TOTALFLUX)/1048576 APRIL_DATA_USAGE_MB 
FROM L3_DATA  P
WHERE  (G383_CHARGINGTIME_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                                                       AND  (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR')))
GROUP BY G401_MAINOFFERINGID,G372_CALLINGPARTYNUMBER
)
WHERE APRIL_DATA_USAGE_MB>=5
)B
WHERE B.G401_MAINOFFERINGID=A.PRODUCT_ID
GROUP BY PRODUCT_NAME
)R ON P.PRODUCT_NAME=R.PRODUCT_NAME
SELECT P.PRODUCT_NAME,COALESCE (ACTIVE_SUBSCRIBERS_COUNT, 0)ACTIVE_SUBSCRIBERS_COUNT,COALESCE (DATA_ACTIVE_SUBSCRIBERS_COUNT, 0)DATA_ACTIVE_SUBSCRIBERS_COUNT
FROM 
PRODUCT_DIM P

LEFT OUTER JOIN

(select PRODUCT_NAME, count(MSISDN)  ACTIVE_SUBSCRIBERS_COUNT from
(select /*+PARALLEL(P,15)*/PRODUCT_NAME, MSISDN
from
(SELECT /*+PARALLEL(A,15)*/ A.MSISDN, C.PRODUCT_NAME
FROM LAST_ACTIVITY_FCT_LD A, PRODUCT_DIM C
WHERE (LU_DATE_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(sysdate-90,'DD/MM/RRRR'))
                                                       AND  (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(sysdate-1,'DD/MM/RRRR'))) and 
 ((A.LU_MOC_PRODUCT_KEY=C.PRODUCT_ID) or (A.LU_MTC_PRODUCT_KEY=C.PRODUCT_ID) or (A.LU_MOSMS_PRODUCT_KEY=C.PRODUCT_ID) 
or (A.LU_GPRS_PRODUCT_KEY=C.PRODUCT_ID) or (A.LR_PRODUCT_KEY=C.PRODUCT_ID))
)P

group by MSISDN,PRODUCT_NAME
)
group by PRODUCT_NAME
) Q ON P.PRODUCT_NAME=Q.PRODUCT_NAME

LEFT OUTER JOIN 

(SELECT A.PRODUCT_NAME,COUNT(UNIQUE G372_CALLINGPARTYNUMBER) DATA_ACTIVE_SUBSCRIBERS_COUNT  FROM PRODUCT_DIM A,
(SELECT G401_MAINOFFERINGID,G372_CALLINGPARTYNUMBER
FROM
(SELECT /*+PARALLEL(P,15)*/ G401_MAINOFFERINGID,G372_CALLINGPARTYNUMBER,SUM (G384_TOTALFLUX)/1048576 APRIL_DATA_USAGE_MB 
FROM L3_DATA  P
WHERE  (G383_CHARGINGTIME_KEY BETWEEN (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
                                                       AND  (SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-1,'DD/MM/RRRR')))
GROUP BY G401_MAINOFFERINGID,G372_CALLINGPARTYNUMBER
)
WHERE APRIL_DATA_USAGE_MB>=5
)B
WHERE B.G401_MAINOFFERINGID=A.PRODUCT_ID
GROUP BY PRODUCT_NAME
)R ON P.PRODUCT_NAME=R.PRODUCT_NAME
