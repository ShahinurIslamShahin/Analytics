SELECT U.SAF_RETAILERMOBILE,U.SELLER_INFO,U.SAF_ENTRYDATE,U.PRODUCTNAME, NVL(TOTAL_COUNT,0)TOTAL_COUNT ,NVL(EXISTING,0)EXISTING_CUSTOMER_COUNT,
       NVL(FRESH_CUSTOMER,0) FRESH_CUSTOMER_COUNT
FROM 
(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) TOTAL_COUNT
FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A 

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME
ORDER BY SAF_RETAILERMOBILE
)U

LEFT OUTER JOIN

(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) EXISTING
FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
AND EXISTS
(SELECT * FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_NID,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
)Q
WHERE Q.SAF_NID=P.SAF_NID AND Q.SAF_ENTRYDATE<TO_DATE(SUBSTR(P.SAF_ENTRYDATE,1,9))
)
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME

)V ON U.SAF_RETAILERMOBILE=V.SAF_RETAILERMOBILE AND U.SAF_ENTRYDATE=V.SAF_ENTRYDATE

LEFT OUTER JOIN

(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) FRESH_CUSTOMER
FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
AND NOT EXISTS
(SELECT * FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_NID,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
)Q
WHERE Q.SAF_NID=P.SAF_NID AND Q.SAF_ENTRYDATE<TO_DATE(SUBSTR(P.SAF_ENTRYDATE,1,9))
)
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME
)W ON U.SAF_RETAILERMOBILE=W.SAF_RETAILERMOBILE AND U.SAF_ENTRYDATE=W.SAF_ENTRYDATE