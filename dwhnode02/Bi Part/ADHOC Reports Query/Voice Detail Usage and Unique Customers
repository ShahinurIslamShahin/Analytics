

--------------------------------------------VOICE Detail Usages---------------------------------------

CREATE TABLE SHAIN_MARKETING_VOICE_DEATIL_USAGE_JANUARY
AS
SELECT /*+PARALLEL(P,15)*/MONTH_LONG, YEAR,V397_MAINOFFERINGID ,
count(
CASE 
WHEN V397_MAINOFFERINGID=V436_LASTEFFECTOFFERING AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) BASE_TARIFF_REVENUE,
count(
CASE 
WHEN V397_MAINOFFERINGID=V436_LASTEFFECTOFFERING AND V402_CALLTYPE !=3
THEN V35_RATE_USAGE
END
)/60 BASE_TARIFF_MINUTES,

count(
CASE 
WHEN V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Tariff') AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) RATE_CUTTER_REVENUE,

count(
CASE 
WHEN V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Tariff') AND V402_CALLTYPE !=3
THEN V35_RATE_USAGE
END
)/60 RATE_CUTTER_MINUITES,

count(
CASE 
WHEN V436_LASTEFFECTOFFERING=598878 AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) RATE_INCREASER_REVENUE,
count(
CASE 
WHEN V436_LASTEFFECTOFFERING=598878 AND V402_CALLTYPE !=3
THEN V35_RATE_USAGE
END
)/60 RATE_INCREASER_MINUTES,

count(
CASE 
WHEN V436_LASTEFFECTOFFERING NOT IN (SELECT TO_CHAR(PRODUCT_ID) FROM DWH_USER.PRODUCT_DIM UNION SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM) AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) SHORT_CODE_REVENUE,
count(
CASE 
WHEN V436_LASTEFFECTOFFERING NOT IN (SELECT TO_CHAR(PRODUCT_ID) FROM DWH_USER.PRODUCT_DIM UNION SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM) AND V402_CALLTYPE !=3
THEN V35_RATE_USAGE
END
)/60 SHORT_CODE_MINUTES,

count(
CASE 
WHEN V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='FNF') AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) FNF_REVENUE,

count(
CASE 
WHEN V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='FNF') AND V402_CALLTYPE !=3
THEN V35_RATE_USAGE
END
)/60 FNF_MINUTES,

count(
CASE 
WHEN  V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Video') AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) VIDEO_REVENUE,
count(
CASE 
WHEN  V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Video') AND V402_CALLTYPE !=3
THEN V35_RATE_USAGE
END
)/60 VIDEO_MINUTES,

count(
CASE 
WHEN   V436_LASTEFFECTOFFERING =585067 AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) CLOSED_SIM_REVENUE,
count(
CASE 
WHEN   V436_LASTEFFECTOFFERING =585067 AND V402_CALLTYPE !=3
THEN V35_RATE_USAGE
END
)/60 CLOSED_SIM_MINUTES,

count(
CASE 
WHEN   V402_CALLTYPE=3
THEN V41_DEBIT_AMOUNT
END
) IN_VOICE_REVENUE,

count(
CASE 
WHEN   V402_CALLTYPE=3
THEN V35_RATE_USAGE
END
)/60 IN_VOICE_MINUTES,

count(
CASE 
WHEN   V436_LASTEFFECTOFFERING =402326 AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) DISCOUNT_REVENUE,
count(
CASE 
WHEN   V436_LASTEFFECTOFFERING =402326 AND V402_CALLTYPE !=3
THEN V35_RATE_USAGE
END
)/60 DISCOUNT_MINUTES,
COUNT(DISTINCT V372_CALLINGPARTYNUMBER) UNIQUE_USERS_COUNT


FROM DWH_USER.L3_VOICE P,DWH_USER.DATE_DIM Q
WHERE (V387_CHARGINGTIME_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/01/2021','DD/MM/RRRR')))
                                      AND  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('31/01/2021','DD/MM/RRRR'))))
    AND V378_SERVICEFLOW=1
   AND V387_CHARGINGTIME_KEY=DATE_KEY
GROUP BY MONTH_LONG, YEAR,V397_MAINOFFERINGID



------------------------------------------------------Voice Detail unique customers-----------------------------------------


SELECT /*+PARALLEL(P,15)*/MONTH_LONG, YEAR,V397_MAINOFFERINGID ,

Count(distinct
(
CASE
WHEN V397_MAINOFFERINGID=V436_LASTEFFECTOFFERING AND V402_CALLTYPE !=3
THEN V372_CALLINGPARTYNUMBER
END
)
) BASE_TARIFF_subscribers_count,


COUNT(distinct
(
CASE
WHEN V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Tariff') AND V402_CALLTYPE !=3
THEN V372_CALLINGPARTYNUMBER
END
)
) RATE_CUTTER_susbcribers_count,


COUNT
(DISTINCT
(
CASE
WHEN V436_LASTEFFECTOFFERING=598878 AND V402_CALLTYPE !=3
THEN V372_CALLINGPARTYNUMBER
END
)
) RATE_INCREASER_SUBSCRIBERS_COUNT,


COUNT
(DISTINCT
(
CASE
WHEN V436_LASTEFFECTOFFERING NOT IN (SELECT TO_CHAR(PRODUCT_ID) FROM DWH_USER.PRODUCT_DIM UNION SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM) AND V402_CALLTYPE !=3
THEN V372_CALLINGPARTYNUMBER
END
)
) SHORT_CODE_SUBSCRIBERS_COUNT,

COUNT
(DISTINCT
(
CASE
WHEN V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='FNF') AND V402_CALLTYPE !=3
THEN V372_CALLINGPARTYNUMBER
END
)
) FNF_sUBSCRIBERS_COUNT,

COUNT
(DISTINCT
(
CASE
WHEN  V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Video') AND V402_CALLTYPE !=3
THEN V372_CALLINGPARTYNUMBER
END
)
) VIDEO_SUBSCRIBERS_COUNT,


COUNT
(DISTINCT
(
CASE
WHEN   V436_LASTEFFECTOFFERING =585067 AND V402_CALLTYPE !=3
THEN V372_CALLINGPARTYNUMBER
END
)
) CLOSED_SIM_SUBSCRIBERS_COUNT,



COUNT
(DISTINCT
(
CASE
WHEN   V402_CALLTYPE=3
THEN V372_CALLINGPARTYNUMBER
END
)
) IN_VOICE_SUBSCRIBERS_COUNT,


COUNT(
DISTINCT
(
CASE
WHEN   V436_LASTEFFECTOFFERING =402326 AND V402_CALLTYPE !=3
THEN V35_RATE_USAGE
END
)
) DISCOUNT_SUBSCRIBERS,
COUNT(DISTINCT V372_CALLINGPARTYNUMBER) TOTAL_UNIQUE_USERS_COUNT


FROM DWH_USER.L3_VOICE P,DWH_USER.DATE_DIM Q
WHERE (V387_CHARGINGTIME_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/01/2021','DD/MM/RRRR')))
                                      AND  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('31/01/2021','DD/MM/RRRR'))))
    AND V378_SERVICEFLOW=1
   AND V387_CHARGINGTIME_KEY=DATE_KEY
GROUP BY MONTH_LONG, YEAR,V397_MAINOFFERINGID
