SELECT /*+PARALLEL(P,15)*/MONTH_KEY, MONTH_LONG,MSISDN,PRODUCT_KEY,MONTHLY_RECHARGE_AMOUNT,MONTHLY_RECHARGE_COUNT,MONTHLY_VOICE_AMOUNT+MONTHLY_DATA_AMOUNT+MONTHLY_RECURRING_AMOUNT+MONTHLY_SMS_AMOUNT MONTHLY_USAGE
FROM 
(SELECT /*+PARALLEL(P,15)*/MONTH_KEY, MONTH_LONG, RE6_PRI_IDENTITY MSISDN, RE489_MAINOFFERINGID PRODUCT_KEY, NVL(SUM(MONTHLY_RECHARGE_AMOUNT),0)MONTHLY_RECHARGE_AMOUNT , 
       NVL(SUM(MONTHLY_RECHARGE_COUNT),0)MONTHLY_RECHARGE_COUNT,NVL(SUM(MONTHLY_VOICE_AMOUNT),0)MONTHLY_VOICE_AMOUNT,NVL(SUM(MONTHLY_DATA_AMOUNT),0)MONTHLY_DATA_AMOUNT, 
       NVL(SUM(MONTHLY_RECURRING_AMOUNT),0) MONTHLY_RECURRING_AMOUNT,NVL(SUM(MONTHLY_SMS_AMOUNT),0) MONTHLY_SMS_AMOUNT 
FROM
(SELECT /*+PARALLEL(P,15)*/ MONTH_KEY, MONTH_LONG, RE6_PRI_IDENTITY, RE489_MAINOFFERINGID, MONTHLY_RECHARGE_AMOUNT, MONTHLY_RECHARGE_COUNT,
       NULL AS MONTHLY_VOICE_AMOUNT,NULL AS MONTHLY_DATA_AMOUNT, NULL AS MONTHLY_RECURRING_AMOUNT,NULL AS MONTHLY_SMS_AMOUNT 
FROM SHAHIN_MONTH_WISE_RECHARGE_HISTORY P
UNION ALL
SELECT /*+PARALLEL(P,15)*/ MONTH_KEY, MONTH_LONG, V372_CALLINGPARTYNUMBER ,V397_MAINOFFERINGID, NULL AS MONTHLY_RECHARGE_AMOUNT, NULL AS MONTHLY_RECHARGE_COUNT,
       MONTHLY_VOICE_AMOUNT,NULL AS MONTHLY_DATA_AMOUNT, NULL AS MONTHLY_RECURRING_AMOUNT,NULL AS MONTHLY_SMS_AMOUNT 
FROM SHAHIN_MONTH_WISE_VOICE_HISTORY P
UNION ALL
SELECT /*+PARALLEL(P,15)*/ MONTH_KEY, MONTH_LONG, G372_CALLINGPARTYNUMBER ,G401_MAINOFFERINGID, NULL AS MONTHLY_RECHARGE_AMOUNT, NULL AS MONTHLY_RECHARGE_COUNT,
       NULL AS MONTHLY_VOICE_AMOUNT,MONTHLY_DATA_AMOUNT, NULL AS MONTHLY_RECURRING_AMOUNT,NULL AS MONTHLY_SMS_AMOUNT 
FROM SHAHIN_MONTH_WISE_DATA_HISTORY P
UNION ALL
SELECT /*+PARALLEL(P,15)*/ MONTH_KEY, MONTH_LONG, R375_CHARGINGPARTYNUMBER ,R373_MAINOFFERINGID, NULL AS MONTHLY_RECHARGE_AMOUNT, NULL AS MONTHLY_RECHARGE_COUNT,
       NULL AS MONTHLY_VOICE_AMOUNT,NULL AS MONTHLY_DATA_AMOUNT, MONTHLY_RECURRING_AMOUNT,NULL AS MONTHLY_SMS_AMOUNT 
FROM SHAHIN_MONTH_WISE_RECURRING_HISTORY P
UNION ALL
SELECT /*+PARALLEL(P,15)*/ MONTH_KEY, MONTH_LONG, S22_PRI_IDENTITY ,S395_MAINOFFERINGID, NULL AS MONTHLY_RECHARGE_AMOUNT, NULL AS MONTHLY_RECHARGE_COUNT,
       NULL AS MONTHLY_VOICE_AMOUNT,NULL AS MONTHLY_DATA_AMOUNT, NULL AS MONTHLY_RECURRING_AMOUNT, MONTHLY_SMS_AMOUNT 
FROM SHAHIN_MONTH_WISE_SMS_HISTORY P
)P
GROUP BY MONTH_KEY, MONTH_LONG, RE6_PRI_IDENTITY, RE489_MAINOFFERINGID
)P
ORDER BY MSISDN,MONTH_KEY



CREATE TABLE SHAHIN_MONTH_WISE_RECHARGE_HISTORY
AS
(
SELECT /*+PARALLEL(P,15)*/ MONTH_KEY,MONTH_LONG,RE6_PRI_IDENTITY ,RE489_MAINOFFERINGID,SUM(RE3_RECHARGE_AMT) MONTHLY_RECHARGE_AMOUNT,
       COUNT( RE3_RECHARGE_AMT) MONTHLY_RECHARGE_COUNT
FROM DWH_USER.L3_RECHARGE P,DATE_DIM Q
WHERE (RE30_ENTRY_DATE_KEY BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/01/2021','DD/MM/RRRR')))
                            AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('31/03/2021','DD/MM/RRRR'))))
      AND P.RE30_ENTRY_DATE_KEY=Q.DATE_KEY
                            
GROUP BY MONTH_KEY,MONTH_LONG,RE6_PRI_IDENTITY ,RE489_MAINOFFERINGID
)
CREATE TABLE SHAHIN_MONTH_WISE_VOICE_HISTORY
AS
(
SELECT /*+PARALLEL(P,15)*/ MONTH_KEY,MONTH_LONG,V372_CALLINGPARTYNUMBER ,V397_MAINOFFERINGID,SUM(V41_DEBIT_AMOUNT) MONTHLY_VOICE_AMOUNT
  
FROM DWH_USER.L3_VOICE P,DATE_DIM Q
WHERE (V387_CHARGINGTIME_KEY BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/01/2021','DD/MM/RRRR')))
                            AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('31/03/2021','DD/MM/RRRR'))))
      AND V378_SERVICEFLOW='1'
      AND P.V387_CHARGINGTIME_KEY=Q.DATE_KEY
                            
GROUP BY MONTH_KEY,MONTH_LONG,V372_CALLINGPARTYNUMBER ,V397_MAINOFFERINGID
)



CREATE TABLE SHAHIN_MONTH_WISE_DATA_HISTORY
AS
(
SELECT /*+PARALLEL(P,15)*/ MONTH_KEY,MONTH_LONG,G372_CALLINGPARTYNUMBER ,G401_MAINOFFERINGID,SUM(G41_DEBIT_AMOUNT) MONTHLY_DATA_AMOUNT
  
FROM DWH_USER.L3_DATA P,DATE_DIM Q
WHERE (G383_CHARGINGTIME_KEY BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/01/2021','DD/MM/RRRR')))
                            AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('31/03/2021','DD/MM/RRRR'))))
      AND P.G383_CHARGINGTIME_KEY=Q.DATE_KEY
                            
GROUP BY MONTH_KEY,MONTH_LONG,G372_CALLINGPARTYNUMBER ,G401_MAINOFFERINGID
)



CREATE TABLE SHAHIN_MONTH_WISE_RECURRING_HISTORY
AS
(
SELECT /*+PARALLEL(P,15)*/ MONTH_KEY,MONTH_LONG,R375_CHARGINGPARTYNUMBER ,R373_MAINOFFERINGID,SUM(R41_DEBIT_AMOUNT) MONTHLY_RECURRING_AMOUNT
  
FROM DWH_USER.L3_RECURRING P,DATE_DIM Q
WHERE (R377_CYCLEBEGINTIME_KEY BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/01/2021','DD/MM/RRRR')))
                            AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('31/03/2021','DD/MM/RRRR'))))
      AND P.R377_CYCLEBEGINTIME_KEY=Q.DATE_KEY
                            
GROUP BY MONTH_KEY,MONTH_LONG,R375_CHARGINGPARTYNUMBER ,R373_MAINOFFERINGID
)


CREATE TABLE SHAHIN_MONTH_WISE_SMS_HISTORY
AS
(
SELECT /*+PARALLEL(P,15)*/ MONTH_KEY,MONTH_LONG,S22_PRI_IDENTITY ,S395_MAINOFFERINGID,SUM(S41_DEBIT_AMOUNT) MONTHLY_SMS_AMOUNT
  
FROM DWH_USER.L3_SMS P,DATE_DIM Q
WHERE (S387_CHARGINGTIME_KEY BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/01/2021','DD/MM/RRRR')))
                            AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('31/03/2021','DD/MM/RRRR'))))
      AND S378_SERVICEFLOW='1'
      AND P.S387_CHARGINGTIME_KEY=Q.DATE_KEY
      
                            
GROUP BY MONTH_KEY,MONTH_LONG,S22_PRI_IDENTITY ,S395_MAINOFFERINGID
)