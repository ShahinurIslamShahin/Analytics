CREATE TABLE TOTAL_RETAILER_ATTACHED_SIM_TC
AS
SELECT MONTH_SHORT,LFTPOINT_NAME, COUNT(UNIQUE TELECHARGE_NO) TOTAL_RETAILER_ATTACHED_SIM_TC
FROM
(
(SELECT MONTH_SHORT,LFTPOINT_NAME,TELECHARGE_NO  FROM 
(SELECT RETAILER_NO,CONCAT('880',TELECHARGE_NO)TELECHARGE_NO,DEALER_NO,
       CUSTOMER_NO ,DIST_LIFTING_POINT ,
       CASE 
       WHEN LFTPOINT_NAME  IS NOT NULL
       THEN LFTPOINT_NAME
       WHEN LFTPOINT_NAME  IS  NULL
       THEN 'Common Lifting point'
       END LFTPOINT_NAME
       FROM 
(SELECT /*+PARALLEL(P,15)*/UNIQUE RETAILER_NO,TELECHARGE_NO,DEALER_NO 
FROM TTALK_DMS.S_BI_ACC_DM_RETAILER_INFO_V@DWH05TO_DMS P)A
LEFT OUTER JOIN 
(SELECT /*+PARALLEL(P,15)*/UNIQUE CUSTOMER_NO ,DIST_LIFTING_POINT ,LFTPOINT_NAME
FROM TTALK_DMS.S_BI_ACC_DM_DEALER_INFO_V@DWH05TO_DMS P, TTALK_DMS.S_BI_ACC_DM_LIFTINGPOINT_V@DWH05TO_DMS Q
WHERE DIST_LIFTING_POINT= LFTPOINT_NO)B ON A.DEALER_NO=B.CUSTOMER_NO) C
INNER JOIN
(SELECT /*+PARALLEL(P,15)*/ UNIQUE MONTH_SHORT, ER03_MSISDN_DEALER 
FROM L3_EVCREC P,DATE_DIM Q
WHERE ER12_RECHARGE_DATE_KEY BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/01/2021','DD/MM/RRRR')))
                             AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('10/07/2021','DD/MM/RRRR')))
AND ER15_TRANSACTION_STATUS=0
AND ER12_RECHARGE_DATE_KEY=DATE_KEY
)D ON  C.TELECHARGE_NO=D.ER03_MSISDN_DEALER
GROUP BY MONTH_SHORT,LFTPOINT_NAME,TELECHARGE_NO
)

UNION

(SELECT MONTH,LFTPOINT_NAME ZONE ,TELECHARGE_NO FROM 
(SELECT RETAILER_NO,CONCAT('880',TELECHARGE_NO)TELECHARGE_NO,DEALER_NO,
       CUSTOMER_NO ,DIST_LIFTING_POINT ,
       CASE 
       WHEN LFTPOINT_NAME  IS NOT NULL
       THEN LFTPOINT_NAME
       WHEN LFTPOINT_NAME  IS  NULL
       THEN 'Common Lifting point'
       END LFTPOINT_NAME
       FROM 
(SELECT /*+PARALLEL(P,15)*/UNIQUE RETAILER_NO,TELECHARGE_NO,DEALER_NO 
FROM TTALK_DMS.S_BI_ACC_DM_RETAILER_INFO_V@DWH05TO_DMS P)A
LEFT OUTER JOIN 
(SELECT /*+PARALLEL(P,15)*/UNIQUE CUSTOMER_NO ,DIST_LIFTING_POINT ,LFTPOINT_NAME
FROM TTALK_DMS.S_BI_ACC_DM_DEALER_INFO_V@DWH05TO_DMS P, TTALK_DMS.S_BI_ACC_DM_LIFTINGPOINT_V@DWH05TO_DMS Q
WHERE DIST_LIFTING_POINT= LFTPOINT_NO)B ON A.DEALER_NO=B.CUSTOMER_NO) C
INNER JOIN 
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE,SUBSTR(SAF_ENTRYDATE,4,3) MONTH
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4
AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN','NEW_POSTPAID')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN TO_DATE('01/01/2021','DD/MM/RRRR') AND TO_DATE('10/07/2021','DD/MM/RRRR')
GROUP BY SAF_RETAILERMOBILE,SUBSTR(SAF_ENTRYDATE,4,3)
)D ON C.TELECHARGE_NO=D.SAF_RETAILERMOBILE
GROUP BY MONTH,LFTPOINT_NAME,TELECHARGE_NO

)
)
GROUP BY MONTH_SHORT,LFTPOINT_NAME



------------------------------------------------------------------------------------------


CREATE TABLE SHAHIN_ADHOC_TOTAL_SIM_SALE_NEW
AS
SELECT * FROM 
(SELECT MONTH,LFTPOINT_NAME ZONE ,SUM(TOTAL_SIM_SALE)TOTAL_SIM_SALE  FROM 
(SELECT RETAILER_NO,CONCAT('880',TELECHARGE_NO)TELECHARGE_NO,DEALER_NO,
       CUSTOMER_NO ,DIST_LIFTING_POINT ,
       CASE 
       WHEN LFTPOINT_NAME  IS NOT NULL
       THEN LFTPOINT_NAME
       WHEN LFTPOINT_NAME  IS  NULL
       THEN 'Common Lifting point'
       END LFTPOINT_NAME
       FROM 
(SELECT /*+PARALLEL(P,15)*/UNIQUE RETAILER_NO,TELECHARGE_NO,DEALER_NO 
FROM TTALK_DMS.S_BI_ACC_DM_RETAILER_INFO_V@DWH05TO_DMS P)A
LEFT OUTER JOIN 
(SELECT /*+PARALLEL(P,15)*/UNIQUE CUSTOMER_NO ,DIST_LIFTING_POINT ,LFTPOINT_NAME
FROM TTALK_DMS.S_BI_ACC_DM_DEALER_INFO_V@DWH05TO_DMS P, TTALK_DMS.S_BI_ACC_DM_LIFTINGPOINT_V@DWH05TO_DMS Q
WHERE DIST_LIFTING_POINT= LFTPOINT_NO)B ON A.DEALER_NO=B.CUSTOMER_NO) C
INNER JOIN
(SELECT /*+PARALLEL(P,15)*/SAF_RETAILERMOBILE,SUBSTR(SAF_ENTRYDATE,4,3) MONTH, COUNT(*)TOTAL_SIM_SALE 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4
AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN','NEW_POSTPAID')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN TO_DATE('01/01/2021','DD/MM/RRRR') AND TO_DATE('10/07/2021','DD/MM/RRRR')
GROUP BY SAF_RETAILERMOBILE,SUBSTR(SAF_ENTRYDATE,4,3)
)D ON C.TELECHARGE_NO=D.SAF_RETAILERMOBILE
GROUP BY MONTH,LFTPOINT_NAME

)
WHERE MONTH IS NOT NULL
ORDER BY ZONE







-----------------------------------------------------------------------------



CREATE TABLE SHAHIN_ADHOC_TOTAL_TC_SALE_DEALER_NEW
AS
SELECT * FROM 
(SELECT MONTH_SHORT,LFTPOINT_NAME ZONE ,SUM(TRAN_AMOUNT)TRAN_AMOUNT  FROM 
(SELECT RETAILER_NO,CONCAT('880',TELECHARGE_NO)TELECHARGE_NO,DEALER_NO,
       CUSTOMER_NO ,DIST_LIFTING_POINT ,
       CASE 
       WHEN LFTPOINT_NAME  IS NOT NULL
       THEN LFTPOINT_NAME
       WHEN LFTPOINT_NAME  IS  NULL
       THEN 'Common Lifting point'
       END LFTPOINT_NAME
       FROM 
(SELECT /*+PARALLEL(P,15)*/UNIQUE RETAILER_NO,TELECHARGE_NO,DEALER_NO 
FROM TTALK_DMS.S_BI_ACC_DM_RETAILER_INFO_V@DWH05TO_DMS P)A
LEFT OUTER JOIN 
(SELECT /*+PARALLEL(P,15)*/UNIQUE CUSTOMER_NO ,DIST_LIFTING_POINT ,LFTPOINT_NAME
FROM TTALK_DMS.S_BI_ACC_DM_DEALER_INFO_V@DWH05TO_DMS P, TTALK_DMS.S_BI_ACC_DM_LIFTINGPOINT_V@DWH05TO_DMS Q
WHERE DIST_LIFTING_POINT= LFTPOINT_NO)B ON A.DEALER_NO=B.CUSTOMER_NO) C
INNER JOIN
(SELECT /*+PARALLEL(P,8)*/ ET06_MSISDN_BENEFICIARY,MONTH_SHORT,SUM(ET09_PRICE_TYPE) TRAN_AMOUNT 
FROM L3_EVCTRA P,DATE_DIM Q
WHERE ET12_TRANSFER_DATE_KEY BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/01/2021','DD/MM/RRRR')))
                             AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('10/07/2021','DD/MM/RRRR')))
    
      AND ET13_STATE=0 AND ET12_TRANSFER_DATE_KEY=DATE_KEY
GROUP BY ET06_MSISDN_BENEFICIARY,MONTH_SHORT    
)D ON C.TELECHARGE_NO=D.ET06_MSISDN_BENEFICIARY
GROUP BY MONTH_SHORT,LFTPOINT_NAME

)
WHERE MONTH_SHORT IS NOT NULL
ORDER BY ZONE


-----------------------------------------------------------



SELECT MONTH, ZONE,SUM(TOTAL_SIM_SALE)TOTAL_SIM_SALE, SUM(TRAN_AMOUNT)TOTAL_TC_SALE,SUM(TOTAL_RETAILER_ATTACHED_SIM_TC)TOTAL_RETAILER_ATTACHED_SIM_TC
FROM
(SELECT INITCAP(MONTH)MONTH, ZONE, TOTAL_SIM_SALE,NULL AS TRAN_AMOUNT,NULL AS TOTAL_RETAILER_ATTACHED_SIM_TC FROM SHAHIN_ADHOC_TOTAL_SIM_SALE_NEW
UNION ALL 
SELECT INITCAP(MONTH_SHORT)MONTH_SHORT, ZONE, NULL AS TOTAL_SIM_SALE, TRAN_AMOUNT, NULL AS TOTAL_RETAILER_ATTACHED_SIM_TC FROM SHAHIN_ADHOC_TOTAL_TC_SALE_DEALER_NEW
UNION ALL
SELECT INITCAP(MONTH_SHORT)MONTH_SHORT, LFTPOINT_NAME, NULL AS TOTAL_SIM_SALE,NULL AS TRAN_AMOUNT,TOTAL_RETAILER_ATTACHED_SIM_TC FROM TOTAL_RETAILER_ATTACHED_SIM_TC
)
GROUP BY MONTH, ZONE
ORDER BY ZONE