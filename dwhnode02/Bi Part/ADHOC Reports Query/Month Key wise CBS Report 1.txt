-----------------------------------CBS REPORT 1--------------------------------


SELECT MONTH_KEY,COALESCE (DURATION, 0)DURATION,COALESCE (COUNT_CALL, 0)COUNT_CALL,COALESCE (RECHARGE_AMOUNT, 0)RECHARGE_AMOUNT,
        COALESCE (VOICE_PAYG_TK, 0)+ COALESCE (VOICE_BUNDLE_REVENUE, 0) VOICE_TK,COALESCE (DATA_PAYG_REVENUE, 0)+ COALESCE (DATA_BUNDLE_REVENUE, 0) DATA_TK,
        COALESCE (SMS_PAYG_REVENUE, 0)+ COALESCE (SMS_BUNDLE_REVENUE, 0) SMS_TK
       

FROM 
(
SELECT MONTH_KEY, SUM(DURATION)DURATION,SUM(COUNT_CALL)COUNT_CALL,SUM(VOICE_PAYG_TK)VOICE_PAYG_TK,SUM(RECHARGE_AMOUNT)RECHARGE_AMOUNT,
       SUM(DATA_PAYG_REVENUE)DATA_PAYG_REVENUE,SUM(SMS_PAYG_REVENUE)SMS_PAYG_REVENUE,SUM(DATA_BUNDLE_REVENUE)DATA_BUNDLE_REVENUE,
       SUM(VOICE_BUNDLE_REVENUE)VOICE_BUNDLE_REVENUE, SUM(SMS_BUNDLE_REVENUE)SMS_BUNDLE_REVENUE
       FROM 
(
(SELECT  /*+PARALLEL(P,15)*/ MONTH_KEY ,SUM(V35_RATE_USAGE)/60 DURATION,COUNT(*)
 COUNT_CALL, SUM(V41_DEBIT_AMOUNT) VOICE_PAYG_TK , NULL AS RECHARGE_AMOUNT,
         NULL AS DATA_PAYG_REVENUE, NULL AS SMS_PAYG_REVENUE, NULL AS DATA_BUNDLE_REVENUE,NULL AS VOICE_BUNDLE_REVENUE, NULL AS SMS_BUNDLE_REVENUE
FROM L3_VOICE P, DATE_DIM Q
WHERE (V387_CHARGINGTIME_KEY IN (SELECT DATE_KEY FROM DATE_DIM WHERE MONTH_KEY = (SELECT TO_CHAR(TO_NUMBER(MONTH_KEY)-1) MONTH_KEY
       FROM DATE_DIM
       WHERE DATE_VALUE = TRUNC(TO_DATE(SYSDATE,'DD/MM/RRRR')))))
AND V378_SERVICEFLOW='1'
AND V387_CHARGINGTIME_KEY=DATE_KEY
GROUP BY MONTH_KEY
)

UNION ALL

(SELECT  /*+PARALLEL(P,8)*/ MONTH_KEY , NULL AS DURATION, NULL AS COUNT_CALL, NULL AS VOICE_PAYG_TK, SUM(RE3_RECHARGE_AMT) RECHARGE_AMOUNT ,
          NULL AS DATA_PAYG_REVENUE, NULL AS SMS_PAYG_REVENUE, NULL AS DATA_BUNDLE_REVENUE,NULL AS VOICE_BUNDLE_REVENUE, NULL AS SMS_BUNDLE_REVENUE
FROM L3_RECHARGE P, DATE_DIM Q
WHERE (RE30_ENTRY_DATE_KEY IN (SELECT DATE_KEY FROM DATE_DIM WHERE MONTH_KEY = (SELECT TO_CHAR(TO_NUMBER(MONTH_KEY)-1) MONTH_KEY
       FROM DATE_DIM
       WHERE DATE_VALUE = TRUNC(TO_DATE(SYSDATE,'DD/MM/RRRR')))))
                                                       
AND RE30_ENTRY_DATE_KEY=DATE_KEY
GROUP BY MONTH_KEY 
)

UNION ALL

(SELECT  /*+PARALLEL(P,8)*/ MONTH_KEY , NULL AS DURATION, NULL AS COUNT_CALL, NULL AS VOICE_PAYG_TK, NULL AS RECHARGE_AMOUNT,
          SUM(G41_DEBIT_AMOUNT) DATA_PAYG_REVENUE , NULL AS SMS_PAYG_REVENUE, NULL AS DATA_BUNDLE_REVENUE,NULL AS VOICE_BUNDLE_REVENUE, NULL AS SMS_BUNDLE_REVENUE
FROM L3_DATA P,DATE_DIM Q
WHERE (G383_CHARGINGTIME_KEY IN (SELECT DATE_KEY FROM DATE_DIM WHERE MONTH_KEY = (SELECT TO_CHAR(TO_NUMBER(MONTH_KEY)-1) MONTH_KEY
       FROM DATE_DIM
       WHERE DATE_VALUE = TRUNC(TO_DATE(SYSDATE,'DD/MM/RRRR')))))
                                                       
AND G383_CHARGINGTIME_KEY=DATE_KEY
                                                      

GROUP BY MONTH_KEY 
)

UNION ALL

(SELECT  /*+PARALLEL(P,8)*/ MONTH_KEY , NULL AS DURATION, NULL AS COUNT_CALL, NULL AS VOICE_PAYG_TK, NULL AS RECHARGE_AMOUNT,
          NULL AS DATA_PAYG_REVENUE ,SUM(S41_DEBIT_AMOUNT) SMS_PAYG_REVENUE , NULL AS DATA_BUNDLE_REVENUE,NULL AS VOICE_BUNDLE_REVENUE, NULL AS SMS_BUNDLE_REVENUE
FROM L3_SMS P, DATE_DIM Q
WHERE (S387_CHARGINGTIME_KEY IN (SELECT DATE_KEY FROM DATE_DIM WHERE MONTH_KEY = (SELECT TO_CHAR(TO_NUMBER(MONTH_KEY)-1) MONTH_KEY
       FROM DATE_DIM
       WHERE DATE_VALUE = TRUNC(TO_DATE(SYSDATE,'DD/MM/RRRR')))))
                                                       
AND S387_CHARGINGTIME_KEY=DATE_KEY
                                                    
GROUP BY MONTH_KEY 
)

UNION ALL

(SELECT  /*+PARALLEL(P,8)*/ MONTH_KEY ,NULL AS DURATION, NULL AS COUNT_CALL, NULL AS VOICE_PAYG_TK, NULL AS RECHARGE_AMOUNT,
          NULL AS DATA_PAYG_REVENUE ,NULL AS SMS_PAYG_REVENUE , 
SUM( CASE 
     WHEN R385_OFFERINGID IN ( SELECT OFFERING_ID FROM OFFER_DIM WHERE OFFER_TYPE='Data')
     THEN R41_DEBIT_AMOUNT
     END) DATA_BUNDLE_REVENUE,
SUM( CASE 
     WHEN R385_OFFERINGID IN ( SELECT OFFERING_ID FROM OFFER_DIM WHERE OFFER_TYPE='Voice')
     THEN R41_DEBIT_AMOUNT
     END) VOICE_BUNDLE_REVENUE,
SUM( CASE 
     WHEN R385_OFFERINGID IN ( SELECT OFFERING_ID FROM OFFER_DIM WHERE OFFER_TYPE='SMS')
     THEN R41_DEBIT_AMOUNT
     END) SMS_BUNDLE_REVENUE
FROM L3_RECURRING P, DATE_DIM Q
WHERE (R377_CYCLEBEGINTIME_KEY IN (SELECT DATE_KEY FROM DATE_DIM WHERE MONTH_KEY = (SELECT TO_CHAR(TO_NUMBER(MONTH_KEY)-1) MONTH_KEY
       FROM DATE_DIM
       WHERE DATE_VALUE = TRUNC(TO_DATE(SYSDATE,'DD/MM/RRRR')))))
                                                       
AND R377_CYCLEBEGINTIME_KEY=DATE_KEY
                                                      

GROUP BY MONTH_KEY 
)
)
GROUP BY MONTH_KEY
)
