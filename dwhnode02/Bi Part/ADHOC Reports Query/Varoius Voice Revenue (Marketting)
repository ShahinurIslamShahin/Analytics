create table MARKETING_VOICE_REVENUE_DECEMBER_VOICE_PART1
AS
SELECT /*+PARALLEL(P,15)*/V387_CHARGINGTIME_KEY,V397_MAINOFFERINGID ,
SUM(
CASE 
WHEN V397_MAINOFFERINGID=V436_LASTEFFECTOFFERING AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) BASE_TARIFF_REVENUE,

SUM(
CASE 
WHEN V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Tariff') AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) RATE_CUTTER_REVENUE,

SUM(
CASE 
WHEN V436_LASTEFFECTOFFERING=598878 AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) RATE_INCREASER_REVENUE,

SUM(
CASE 
WHEN V436_LASTEFFECTOFFERING NOT IN (SELECT TO_CHAR(PRODUCT_ID) FROM DWH_USER.PRODUCT_DIM UNION SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM) AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) SHORT_CODE_REVENUE,

SUM(
CASE 
WHEN V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='FNF') AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) FNF_REVENUE,

SUM(
CASE 
WHEN  V436_LASTEFFECTOFFERING IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Video') AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) VIDEO_REVENUE,

SUM(
CASE 
WHEN   V436_LASTEFFECTOFFERING =585067 AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) CLOSED_SIM_REVENUE,

SUM(
CASE 
WHEN   V402_CALLTYPE=3
THEN V41_DEBIT_AMOUNT
END
) IN_VOICE_REVENUE,

SUM(
CASE 
WHEN   V436_LASTEFFECTOFFERING =402326 AND V402_CALLTYPE !=3
THEN V41_DEBIT_AMOUNT
END
) DISCOUNT_REVENUE

FROM DWH_USER.L3_VOICE P
WHERE V387_CHARGINGTIME_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/12/2020','DD/MM/RRRR')))
                                      AND  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('31/12/2020','DD/MM/RRRR')))
GROUP BY V387_CHARGINGTIME_KEY,V397_MAINOFFERINGID


-------------------------------------------------



create table MARKETING_VOICE_REVENUE_DECEMBER_RECURRING_PART
AS
(SELECT /*+PARALLEL(Q,15)*/ R377_CYCLEBEGINTIME_KEY,R373_MAINOFFERINGID ,
SUM(
CASE
WHEN R385_OFFERINGID IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Voice')
THEN R41_DEBIT_AMOUNT
END) MIN_REVENUE,

SUM(
CASE
WHEN R385_OFFERINGID IN ( SELECT OFFERING_ID FROM DWH_USER.OFFER_DIM WHERE OFFER_TYPE='Combo')
THEN R41_DEBIT_AMOUNT
END) COMBO_REVENUE

FROM DWH_USER.L3_RECURRING   Q
WHERE R377_CYCLEBEGINTIME_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('01/12/2020','DD/MM/RRRR')))
                                      AND  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('31/12/2020','DD/MM/RRRR')))
GROUP BY R377_CYCLEBEGINTIME_KEY, R373_MAINOFFERINGID
)


---------------------------------------------------


SELECT DATE_VALUE,PRODUCT_ID,PRODUCT_NAME,COALESCE (BASE_TARIFF_REVENUE, 0) BASE_TARIFF_REVENUE,COALESCE (MIN_REVENUE, 0)MIN_REVENUE,
          COALESCE (COMBO_REVENUE, 0) COMBO_REVENUE, COALESCE (RATE_CUTTER_REVENUE, 0) RATE_CUTTER_REVENUE,  COALESCE (RATE_INCREASER_REVENUE, 0) RATE_INCREASER_REVENUE,
          COALESCE (SHORT_CODE_REVENUE, 0) SHORT_CODE_REVENUE,COALESCE (FNF_REVENUE, 0) FNF_REVENUE,COALESCE (VIDEO_REVENUE, 0)VIDEO_REVENUE,
          COALESCE (CLOSED_SIM_REVENUE, 0) CLOSED_SIM_REVENUE,COALESCE (IN_VOICE_REVENUE, 0) IN_VOICE_REVENUE,COALESCE (DISCOUNT_REVENUE, 0)DISCOUNT_REVENUE,
          COALESCE (BASE_TARIFF_REVENUE, 0)+COALESCE (MIN_REVENUE, 0)+COALESCE (COMBO_REVENUE, 0)+COALESCE (RATE_CUTTER_REVENUE, 0)+COALESCE (RATE_INCREASER_REVENUE, 0)+
          COALESCE (SHORT_CODE_REVENUE, 0)+COALESCE (FNF_REVENUE, 0)+COALESCE (VIDEO_REVENUE, 0)+COALESCE (CLOSED_SIM_REVENUE, 0)+COALESCE (IN_VOICE_REVENUE, 0)+
          COALESCE (DISCOUNT_REVENUE, 0) TOTAL_VOICE_REVNUE
FROM
(SELECT Q.DATE_VALUE,R.PRODUCT_ID,R.PRODUCT_NAME,SUM(BASE_TARIFF_REVENUE)BASE_TARIFF_REVENUE,SUM(MIN_REVENUE)MIN_REVENUE,SUM(COMBO_REVENUE)COMBO_REVENUE,
       SUM(RATE_CUTTER_REVENUE)RATE_CUTTER_REVENUE,SUM(RATE_INCREASER_REVENUE)RATE_INCREASER_REVENUE,SUM(SHORT_CODE_REVENUE)SHORT_CODE_REVENUE,
       SUM(FNF_REVENUE)FNF_REVENUE, SUM(VIDEO_REVENUE) VIDEO_REVENUE, SUM(CLOSED_SIM_REVENUE)CLOSED_SIM_REVENUE, SUM(IN_VOICE_REVENUE)IN_VOICE_REVENUE,
       SUM(DISCOUNT_REVENUE)DISCOUNT_REVENUE
       FROM
(SELECT /*+PARALLEL(Q,15)*/V387_CHARGINGTIME_KEY, V397_MAINOFFERINGID, BASE_TARIFF_REVENUE, NULL AS MIN_REVENUE, NULL AS COMBO_REVENUE, RATE_CUTTER_REVENUE, 
       RATE_INCREASER_REVENUE, SHORT_CODE_REVENUE, FNF_REVENUE, VIDEO_REVENUE, CLOSED_SIM_REVENUE, IN_VOICE_REVENUE, DISCOUNT_REVENUE 
FROM MARKETING_VOICE_REVENUE_DECEMBER_VOICE_PART1 Q

UNION ALL

SELECT /*+PARALLEL(Q,15)*/R377_CYCLEBEGINTIME_KEY, R373_MAINOFFERINGID ,NULL AS BASE_TARIFF_REVENUE,MIN_REVENUE,COMBO_REVENUE, NULL AS RATE_CUTTER_REVENUE, 
       NULL AS RATE_INCREASER_REVENUE, NULL AS SHORT_CODE_REVENUE, NULL AS FNF_REVENUE, NULL AS VIDEO_REVENUE, NULL CLOSED_SIM_REVENUE, 
       NULL AS IN_VOICE_REVENUE, NULL AS DISCOUNT_REVENUE 
FROM MARKETING_VOICE_REVENUE_DECEMBER_RECURRING_PART Q
)P, date_dim Q,product_dim R
WHERE V387_CHARGINGTIME_KEY=DATE_KEY AND V397_MAINOFFERINGID=PRODUCT_ID
GROUP BY Q.DATE_VALUE,R.PRODUCT_ID,R.PRODUCT_NAME)