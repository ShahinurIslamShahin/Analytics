-----------------------------------------Customer who have no activity-----------------------------


SELECT U.SAF_RETAILERMOBILE,U.SELLER_INFO,U.SAF_ENTRYDATE,U.PRODUCTNAME, NVL(TOTAL_COUNT,0)TOTAL_COUNT ,NVL(EXISTING,0)EXISTING_CUSTOMER_COUNT,
       NVL(FRESH_CUSTOMER,0) FRESH_CUSTOMER_COUNT
FROM 
(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) TOTAL_COUNT
FROM
(SELECT * FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A
WHERE NOT exists
(select * from 
(SELECT /*+PARALLEL(P,15)*/ P.MSISDN
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY !=0
)B
where A.MSISDN=B.MSISDN
)
)A 

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME
)U

LEFT OUTER JOIN

(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) EXISTING
FROM
(SELECT * FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A
WHERE NOT exists
(select * from 
(SELECT /*+PARALLEL(P,15)*/ P.MSISDN
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY !=0
)B
where A.MSISDN=B.MSISDN
)
)A

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
AND EXISTS
(SELECT * FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_NID,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
)Q
WHERE Q.SAF_NID=P.SAF_NID AND Q.SAF_ENTRYDATE<TO_DATE(SUBSTR(P.SAF_ENTRYDATE,1,9))
)
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME

)V ON U.SAF_RETAILERMOBILE=V.SAF_RETAILERMOBILE AND U.SAF_ENTRYDATE=V.SAF_ENTRYDATE

LEFT OUTER JOIN

(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) FRESH_CUSTOMER
FROM
(SELECT * FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A
WHERE NOT exists
(select * from 
(SELECT /*+PARALLEL(P,15)*/ P.MSISDN
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY !=0
)B
where A.MSISDN=B.MSISDN
)
)A

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
AND NOT EXISTS
(SELECT * FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_NID,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
)Q
WHERE Q.SAF_NID=P.SAF_NID AND Q.SAF_ENTRYDATE<TO_DATE(SUBSTR(P.SAF_ENTRYDATE,1,9))
)
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME
)W ON U.SAF_RETAILERMOBILE=W.SAF_RETAILERMOBILE AND U.SAF_ENTRYDATE=W.SAF_ENTRYDATE




-----------------------------------Customer who have only recharge activity-----------------------------------


SELECT U.SAF_RETAILERMOBILE,U.SELLER_INFO,U.SAF_ENTRYDATE,U.PRODUCTNAME, NVL(TOTAL_COUNT,0)TOTAL_COUNT ,NVL(EXISTING,0)EXISTING_CUSTOMER_COUNT,
       NVL(FRESH_CUSTOMER,0) FRESH_CUSTOMER_COUNT
FROM 
(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) TOTAL_COUNT
FROM
(SELECT * FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A
WHERE A.MSISDN IN 
(SELECT /*+PARALLEL(P,15)*/ P.MSISDN
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY !=0
and (LR_DATE_KEY is not null and LU_GPRS_DATE_KEY is null and LU_MOSMS_TIME_KEY is null 
and LU_MTC_DATE_KEY is null and LU_MOC_DATE_KEY is null and LU_MTSMS_DATE_KEY is null)
)
)A 

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME
ORDER BY SAF_RETAILERMOBILE
)U

LEFT OUTER JOIN

(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) EXISTING
FROM
(SELECT * FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A
WHERE A.MSISDN IN 
(SELECT /*+PARALLEL(P,15)*/ P.MSISDN
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY !=0
and (LR_DATE_KEY is not null and LU_GPRS_DATE_KEY is null and LU_MOSMS_TIME_KEY is null 
and LU_MTC_DATE_KEY is null and LU_MOC_DATE_KEY is null and LU_MTSMS_DATE_KEY is null)
)
)A

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
AND EXISTS
(SELECT * FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_NID,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
)Q
WHERE Q.SAF_NID=P.SAF_NID AND Q.SAF_ENTRYDATE<TO_DATE(SUBSTR(P.SAF_ENTRYDATE,1,9))
)
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME

)V ON U.SAF_RETAILERMOBILE=V.SAF_RETAILERMOBILE AND U.SAF_ENTRYDATE=V.SAF_ENTRYDATE

LEFT OUTER JOIN

(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) FRESH_CUSTOMER
FROM
(SELECT * FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A
WHERE A.MSISDN IN 
(SELECT /*+PARALLEL(P,15)*/ P.MSISDN
FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY !=0
and (LR_DATE_KEY is not null and LU_GPRS_DATE_KEY is null and LU_MOSMS_TIME_KEY is null 
and LU_MTC_DATE_KEY is null and LU_MOC_DATE_KEY is null and LU_MTSMS_DATE_KEY is null)
)
)A

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
AND NOT EXISTS
(SELECT * FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_NID,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
)Q
WHERE Q.SAF_NID=P.SAF_NID AND Q.SAF_ENTRYDATE<TO_DATE(SUBSTR(P.SAF_ENTRYDATE,1,9))
)
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME
)W ON U.SAF_RETAILERMOBILE=W.SAF_RETAILERMOBILE AND U.SAF_ENTRYDATE=W.SAF_ENTRYDATE


----------------------------Customer who have high Traffic--------------------------------


SELECT U.SAF_RETAILERMOBILE,U.SELLER_INFO,U.SAF_ENTRYDATE,U.PRODUCTNAME, NVL(TOTAL_COUNT,0)TOTAL_COUNT ,NVL(EXISTING,0)EXISTING_CUSTOMER_COUNT,
       NVL(FRESH_CUSTOMER,0) FRESH_CUSTOMER_COUNT
FROM 
(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) TOTAL_COUNT
FROM
(SELECT * FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A
WHERE A.MSISDN IN 
(SELECT MSISDN FROM 
(SELECT /*+PARALLEL(P,15)*/ MSISDN, SUM(VOICE_REVENUE)VOICE_REVENUE, SUM(DATA_REVENUE )DATA_REVENUE
FROM SUBSCRIBER_USAGE_ANALYSIS P
WHERE DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
GROUP BY MSISDN
HAVING SUM(VOICE_REVENUE)>=300 AND SUM(DATA_REVENUE )<=5
)
)
)A 

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME
ORDER BY SAF_RETAILERMOBILE
)U

LEFT OUTER JOIN

(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) EXISTING
FROM
(SELECT * FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A
WHERE A.MSISDN IN 
(SELECT MSISDN FROM 
(SELECT /*+PARALLEL(P,15)*/ MSISDN, SUM(VOICE_REVENUE)VOICE_REVENUE, SUM(DATA_REVENUE )DATA_REVENUE
FROM SUBSCRIBER_USAGE_ANALYSIS P
WHERE DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
GROUP BY MSISDN
HAVING SUM(VOICE_REVENUE)>=300 AND SUM(DATA_REVENUE )<=5
)
)
)A

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
AND EXISTS
(SELECT * FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_NID,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
)Q
WHERE Q.SAF_NID=P.SAF_NID AND Q.SAF_ENTRYDATE<TO_DATE(SUBSTR(P.SAF_ENTRYDATE,1,9))
)
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME

)V ON U.SAF_RETAILERMOBILE=V.SAF_RETAILERMOBILE AND U.SAF_ENTRYDATE=V.SAF_ENTRYDATE

LEFT OUTER JOIN

(SELECT SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME, COUNT(SAF_MSISDN) FRESH_CUSTOMER
FROM
(SELECT * FROM
(SELECT /*+PARALLEL(Q,15)*/  CONCAT('880',MSISDN) MSISDN, PRODUCTNAME, TO_DATE(ACTIVATION_TIME)ACTIVATION_TIME  
FROM ACTIVATION_REPORT_202012 Q
WHERE PRODUCTNAME IN ('Shotoborsho','Shotoborsho_V1')
--AND TO_DATE(ACTIVATION_TIME) BETWEEN TO_DATE('01/01/2021','DD/MM/YYYY') AND TO_DATE('03/01/2021','DD/MM/YYYY')
)A
WHERE A.MSISDN IN 
(SELECT MSISDN FROM 
(SELECT /*+PARALLEL(P,15)*/ MSISDN, SUM(VOICE_REVENUE)VOICE_REVENUE, SUM(DATA_REVENUE )DATA_REVENUE
FROM SUBSCRIBER_USAGE_ANALYSIS P
WHERE DATE_KEY >=(SELECT DATE_KEY FROM DATE_DIM  WHERE DATE_VALUE = TO_DATE(SYSDATE-30,'DD/MM/RRRR'))
GROUP BY MSISDN
HAVING SUM(VOICE_REVENUE)>=300 AND SUM(DATA_REVENUE )<=5
)
)
)A

LEFT OUTER JOIN

(SELECT /*+PARALLEL(P,15)*/ SAF_MSISDN,SAF_NID,SAF_RETAILERMOBILE,
CASE
WHEN SUBSTR(SAF_RETAILERMOBILE,1,9)='880155015'
THEN 'Customer Care Center'
ELSE 'Retailer'
END SELLER_INFO,
SAF_VERIFIED,SUBSTR(SAF_ENTRYDATE,1,9)SAF_ENTRYDATE ,SAF_REG_TYPE_DESC 
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
AND TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9)) BETWEEN  TO_DATE('01/12/2020','DD/MM/RRRR') AND TO_DATE(sysdate-1,'DD/MM/RRRR')
AND NOT EXISTS
(SELECT * FROM 
(SELECT /*+PARALLEL(P,15)*/ SAF_NID,TO_DATE(SUBSTR(SAF_ENTRYDATE,1,9))SAF_ENTRYDATE
FROM BI_SAF@DWH05TOETSAF P
WHERE SAF_VERIFIED=4 AND SAF_REG_TYPE_DESC IN ('NEW_PREPAID','PREPAID_CAMPAIGN')
)Q
WHERE Q.SAF_NID=P.SAF_NID AND Q.SAF_ENTRYDATE<TO_DATE(SUBSTR(P.SAF_ENTRYDATE,1,9))
)
)B ON MSISDN=SAF_MSISDN

GROUP BY SAF_RETAILERMOBILE,SELLER_INFO,SAF_ENTRYDATE,PRODUCTNAME
)W ON U.SAF_RETAILERMOBILE=W.SAF_RETAILERMOBILE AND U.SAF_ENTRYDATE=W.SAF_ENTRYDATE