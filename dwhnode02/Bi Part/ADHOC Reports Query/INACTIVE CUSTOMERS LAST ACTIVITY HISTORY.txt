--------------------INACTIVE CUSTOMERS LAST ACTIVITY HISTORY-----------------------
(SELECT MSISDN,DATE_VALUE,PRODUCT_NAME,SITE_ID,UPAZILA,DISTRICT,DIVISION,
CASE
WHEN (MO_VOICE_TIME>=DATA_TIME AND MO_VOICE_TIME>=MO_SMS_TIME AND MO_VOICE_TIME>=MT_SMS_TIME AND MO_VOICE_TIME>=RECHARGE_TIME)
  OR (MT_VOICE_TIME>=DATA_TIME AND MT_VOICE_TIME>=MO_SMS_TIME AND MT_VOICE_TIME>=MT_SMS_TIME AND MT_VOICE_TIME>=RECHARGE_TIME)
THEN 'VOICE'
WHEN (MO_SMS_TIME>DATA_TIME AND MO_SMS_TIME>MO_VOICE_TIME AND MO_SMS_TIME>MT_VOICE_TIME AND MO_SMS_TIME>RECHARGE_TIME)
  OR (MT_SMS_TIME>DATA_TIME AND MT_SMS_TIME>MO_VOICE_TIME AND MT_SMS_TIME>MT_VOICE_TIME AND MT_SMS_TIME>RECHARGE_TIME)
THEN 'SMS'
WHEN (DATA_TIME>MO_VOICE_TIME AND DATA_TIME>MT_VOICE_TIME AND DATA_TIME>MT_SMS_TIME AND DATA_TIME>MO_SMS_TIME AND DATA_TIME>MO_SMS_TIME )
  
THEN 'DATA'
ELSE 'OTHERS'
END USAGE_DEPT FROM
(SELECT MSISDN,DATE_VALUE,PRODUCT_NAME,SITE_ID,UPAZILA,DISTRICT,DIVISION,COALESCE (TO_NUMBER(MO_VOICE_TIME), 0)MO_VOICE_TIME,COALESCE (TO_NUMBER(MT_VOICE_TIME), 0)MT_VOICE_TIME,
      COALESCE (TO_NUMBER(DATA_TIME), 0)DATA_TIME,COALESCE (TO_NUMBER(MO_SMS_TIME), 0)MO_SMS_TIME,COALESCE (TO_NUMBER(MT_SMS_TIME), 0)MT_SMS_TIME,
       COALESCE (TO_NUMBER(RECHARGE_TIME), 0)RECHARGE_TIME
FROM
(SELECT MSISDN,DATE_VALUE,PRODUCT_NAME,SITE_ID,INITCAP(UPAZILA)UPAZILA,INITCAP(DISTRICT)DISTRICT,INITCAP(DIVISION)DIVISION,
case 
when (LU_DATE_KEY=LU_MOC_DATE_KEY ) 
then LU_MOC_TIME_KEY --or LU_MTC_TIME_KEY
end MO_VOICE_TIME,
case 
when (LU_DATE_KEY=LU_MTC_DATE_KEY )
then LU_MOC_TIME_KEY --or LU_MTC_TIME_KEY
end MT_VOICE_TIME,
case 
when (LU_DATE_KEY=LU_GPRS_DATE_KEY and LU_TIME_KEY=LU_GPRS_TIME_KEY) 
then LU_GPRS_TIME_KEY
end DATA_TIME,
case
when (LU_DATE_KEY=LU_MOSMS_DATE_KEY)
then LU_MOSMS_TIME_KEY --or LU_MTSMS_TIME_KEY
end MO_SMS_TIME,
case
when  (LU_DATE_KEY=LU_MTSMS_DATE_KEY )
then LU_MOSMS_TIME_KEY --or LU_MTSMS_TIME_KEY
end MT_SMS_TIME,
case
when  (LU_DATE_KEY=LR_DATE_KEY )
then LR_TIME_KEY --or LU_MTSMS_TIME_KEY  LR_DATE_KEY, LR_TIME_KEY
end RECHARGE_TIME

 FROM DATE_DIM P,PRODUCT_DIM Q,ZONE_DIM R,
(SELECT /*+PARALLEL(P,15)*/* FROM LAST_ACTIVITY_FCT_LD P
WHERE LU_DATE_KEY  IN (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE <= TRUNC(TO_DATE(SYSDATE-31,'DD/MM/RRRR')))
)S
WHERE LU_DATE_KEY=DATE_KEY AND LU_PRODUCT_KEY=PRODUCT_ID AND LU_LOCATION_KEY=CGI
)
)
where rownum<50000
)