--------------------------------------------Revenue-------------------------------------------

SELECT ROUND(COALESCE (VOICE_REVENUE, 0)+ COALESCE (DATA_PPU_REVENUE, 0)+ COALESCE (SMS_REVENUE, 0)+ COALESCE (BUNDLE_REVENUE, 0)) TOTAL_REVENUE
FROM
(SELECT /*+PARALLEL(P,15)*/ SUM (V41_DEBIT_AMOUNT) VOICE_REVENUE 
FROM L3_VOICE P
WHERE (V387_CHARGINGTIME_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/02/2021','DD/MM/RRRR')))
                             AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/03/2021','DD/MM/RRRR'))))
      AND V397_MAINOFFERINGID=400100
                             
),
(SELECT /*+PARALLEL(P,15)*/ SUM (G41_DEBIT_AMOUNT) DATA_PPU_REVENUE 
FROM L3_DATA P
WHERE (G383_CHARGINGTIME_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/02/2021','DD/MM/RRRR')))
                             AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/03/2021','DD/MM/RRRR'))))
      AND G401_MAINOFFERINGID=400100
                             
),
(SELECT /*+PARALLEL(P,15)*/ SUM (S41_DEBIT_AMOUNT) SMS_REVENUE  
FROM L3_SMS P
WHERE (S387_CHARGINGTIME_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/02/2021','DD/MM/RRRR')))
                             AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/03/2021','DD/MM/RRRR'))))
      AND S395_MAINOFFERINGID=400100
                             
),
(SELECT /*+PARALLEL(P,15)*/ SUM (R41_DEBIT_AMOUNT) BUNDLE_REVENUE 
FROM L3_RECURRING P
WHERE (R377_CYCLEBEGINTIME_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/02/2021','DD/MM/RRRR')))
                             AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/03/2021','DD/MM/RRRR'))))
      AND R373_MAINOFFERINGID=400100
                             
)



------------------------Migration QTY---------------------

SELECT COUNT( DISTINCT MSISDN) FROM 
(SELECT /*+PARALLEL(P,15)*/  DISTINCT MSISDN,LU_PRODUCT_KEY FROM LAST_ACTIVITY_FCT P
WHERE (ETL_DATE_KEY BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/02/2021','DD/MM/RRRR')))
                            AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/03/2021','DD/MM/RRRR'))))
                         
     AND (LU_DATE_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/02/2021','DD/MM/RRRR')))
                            AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/03/2021','DD/MM/RRRR'))))
     AND LU_PRODUCT_KEY='400100'
)A
WHERE 
EXISTS
(SELECT /*+PARALLEL(B,15)*/ * FROM
(SELECT /*+PARALLEL(P,15)*/ DISTINCT MSISDN,LU_PRODUCT_KEY FROM LAST_ACTIVITY_FCT P
WHERE (ETL_DATE_KEY =  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('20/02/2021','DD/MM/RRRR'))))

)B
WHERE A.MSISDN=B.MSISDN AND A.LU_PRODUCT_KEY !=B.LU_PRODUCT_KEY
)



----------------------------Active subscribers (QTY)----------------------------------


SELECT /*+PARALLEL(P,15)*/ COUNT( DISTINCT MSISDN) FROM LAST_ACTIVITY_FCT P
WHERE (ETL_DATE_KEY BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/12/2020','DD/MM/RRRR')))
                            AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('20/01/2021','DD/MM/RRRR'))))
                         
     AND (LU_DATE_KEY  BETWEEN  (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('21/12/2020','DD/MM/RRRR')))
                            AND (SELECT DATE_KEY FROM DATE_DIM WHERE DATE_VALUE = TRUNC(TO_DATE('20/01/2021','DD/MM/RRRR'))))
     AND LU_PRODUCT_KEY='400100'
